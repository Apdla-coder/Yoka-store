<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ - ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³</title>
    <link rel="stylesheet" href="./header.css" />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #2c3e50, #4ca1af);
        margin: 0;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .register-container {
        background: rgba(255, 255, 255, 0.95);
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 450px;
        text-align: center;
      }

      .logo-section {
        text-align: center;
        margin-bottom: 30px;
      }

      .logo-section img {
        height: 60px;
        margin-bottom: 10px;
      }

      .logo-section h1 {
        color: #2c3e50;
        margin: 0;
        font-size: 28px;
      }

      .logo-section p {
        color: #7f8c8d;
        margin: 5px 0 0 0;
        font-size: 14px;
      }

      .form-group {
        margin-bottom: 20px;
        text-align: right;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #2c3e50;
        font-weight: 600;
        font-size: 14px;
      }

      input, select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
        box-sizing: border-box;
      }

      input:focus, select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }

      .password-group {
        position: relative;
      }

      .password-toggle {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #7f8c8d;
        cursor: pointer;
        font-size: 18px;
      }

      .password-toggle:hover {
        color: #2c3e50;
      }

      .register-btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
      }

      .register-btn:hover {
        background: linear-gradient(135deg, #2980b9, #21618c);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
      }

      .register-btn:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .alert {
        padding: 12px;
        border-radius: 8px;
        margin: 15px 0;
        font-size: 14px;
        display: none;
        text-align: center;
      }

      .alert.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .login-link {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e1e8ed;
      }

      .login-link a {
        color: #3498db;
        text-decoration: none;
        font-weight: 600;
      }

      .login-link a:hover {
        text-decoration: underline;
      }

      .password-strength {
        margin-top: 5px;
        height: 4px;
        border-radius: 2px;
        background: #ecf0f1;
        overflow: hidden;
      }

      .password-strength-bar {
        height: 100%;
        width: 0;
        transition: all 0.3s ease;
        border-radius: 2px;
      }

      .strength-weak { background: #e74c3c; width: 33%; }
      .strength-medium { background: #f39c12; width: 66%; }
      .strength-strong { background: #27ae60; width: 100%; }

      .loading {
        display: none;
        margin-left: 10px;
      }

      .spinner {
        border: 2px solid #ffffff;
        border-top: 2px solid transparent;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: inline-block;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .requirements {
        font-size: 12px;
        color: #7f8c8d;
        text-align: right;
        margin-top: 5px;
      }

      @media (max-width: 480px) {
        .register-container {
          margin: 10px;
          padding: 25px;
        }

        .logo-section h1 {
          font-size: 24px;
        }

        input, select {
          font-size: 16px; /* Prevents zoom on iOS */
        }
      }
    </style>
  </head>
  <body>
    <div class="register-container">
      <div class="logo-section">
        <img src="./Orange_logo.svg.png" alt="Logo" />
        <h1>ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³</h1>
        <p>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</p>
      </div>

      <div id="alertBox" class="alert"></div>

      <form id="registerForm">
        <div class="form-group">
          <label for="name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
          <input 
            type="text" 
            id="name" 
            name="name" 
            required 
            placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„"
            autocomplete="name"
          />
        </div>

        <div class="form-group">
          <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ *</label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            required 
            placeholder="example@email.com"
            autocomplete="email"
          />
        </div>

        <div class="form-group">
          <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
          <input 
            type="tel" 
            id="phone" 
            name="phone" 
            required 
            placeholder="01xxxxxxxxx"
            autocomplete="tel"
          />
        </div>

        <div class="form-group">
          <label for="role">Ø§Ù„Ø¯ÙˆØ± *</label>
          <select id="role" name="role" required>
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ± --</option>
            <option value="agent">Ù…Ù†Ø¯ÙˆØ¨ ØªØ­ØµÙŠÙ„</option>
            <option value="admin">Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…</option>
          </select>
        </div>

        <div class="form-group">
          <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</label>
          <div class="password-group">
            <input 
              type="password" 
              id="password" 
              name="password" 
              required 
              placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
              autocomplete="new-password"
            />
            <button type="button" class="password-toggle" onclick="togglePassword()">
              ğŸ‘ï¸
            </button>
          </div>
          <div class="password-strength">
            <div class="password-strength-bar" id="strengthBar"></div>
          </div>
          <div class="requirements">
            8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ØŒ Ø­Ø±Ù ÙƒØ¨ÙŠØ±ØŒ Ø­Ø±Ù ØµØºÙŠØ±ØŒ ÙˆØ±Ù‚Ù…
          </div>
        </div>

        <div class="form-group">
          <label for="confirmPassword">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</label>
          <div class="password-group">
            <input 
              type="password" 
              id="confirmPassword" 
              name="confirmPassword" 
              required 
              placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
              autocomplete="new-password"
            />
            <button type="button" class="password-toggle" onclick="toggleConfirmPassword()">
              ğŸ‘ï¸
            </button>
          </div>
        </div>

        <button type="submit" class="register-btn" id="registerBtn">
          Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
          <span class="loading" id="loading">
            <div class="spinner"></div>
          </span>
        </button>
      </form>

      <div class="login-link">
        Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ <a href="./index.html">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
      </div>
    </div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const supabase = createClient(
        "https://inguuoiolmbplubkwcvd.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImluZ3V1b2lvbG1icGx1Ymt3Y3ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1MDIxMjksImV4cCI6MjA4NjA3ODEyOX0.wRTnc2LRoy4d77K7RWOeglfsO51kCfN3NlRB7UvyD4Y"
      );

      // Form elements
      const form = document.getElementById("registerForm");
      const alertBox = document.getElementById("alertBox");
      const registerBtn = document.getElementById("registerBtn");
      const loading = document.getElementById("loading");
      const passwordInput = document.getElementById("password");
      const confirmPasswordInput = document.getElementById("confirmPassword");
      const strengthBar = document.getElementById("strengthBar");

      // Password visibility toggle
      window.togglePassword = function() {
        const type = passwordInput.type === "password" ? "text" : "password";
        passwordInput.type = type;
        event.target.textContent = type === "password" ? "ğŸ‘ï¸" : "ğŸ‘ï¸â€ğŸ—¨ï¸";
      };

      window.toggleConfirmPassword = function() {
        const type = confirmPasswordInput.type === "password" ? "text" : "password";
        confirmPasswordInput.type = type;
        event.target.textContent = type === "password" ? "ğŸ‘ï¸" : "ğŸ‘ï¸â€ğŸ—¨ï¸";
      };

      // Password strength checker
      passwordInput.addEventListener("input", function() {
        const password = this.value;
        let strength = 0;

        if (password.length >= 8) strength++;
        if (password.match(/[a-z]/)) strength++;
        if (password.match(/[A-Z]/)) strength++;
        if (password.match(/[0-9]/)) strength++;

        strengthBar.className = "password-strength-bar";
        if (strength === 1) strengthBar.classList.add("strength-weak");
        else if (strength === 2) strengthBar.classList.add("strength-medium");
        else if (strength >= 3) strengthBar.classList.add("strength-strong");
      });

      // Phone number validation
      document.getElementById("phone").addEventListener("input", function() {
        this.value = this.value.replace(/[^0-9]/g, "");
        if (this.value.length > 11) {
          this.value = this.value.slice(0, 11);
        }
      });

      // Form submission
      form.addEventListener("submit", async function(e) {
        e.preventDefault();

        // Get form data
        const formData = new FormData(form);
        const name = formData.get("name").trim();
        const email = formData.get("email").trim().toLowerCase();
        const phone = formData.get("phone").trim();
        const role = formData.get("role");
        const password = formData.get("password");
        const confirmPassword = formData.get("confirmPassword");

        // Validation
        if (!name || !email || !phone || !role || !password || !confirmPassword) {
          showAlert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©", "error");
          return;
        }

        // Email validation
        if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
          showAlert("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­", "error");
          return;
        }

        // Phone validation (Egyptian numbers)
        if (!phone.match(/^(01|020)[0-9]{9,10}$/)) {
          showAlert("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 01 Ø£Ùˆ 020", "error");
          return;
        }

        // Password validation
        if (password.length < 8) {
          showAlert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "error");
          return;
        }

        if (password !== confirmPassword) {
          showAlert("ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†", "error");
          return;
        }

        // Show loading
        setLoading(true);
        hideAlert();

        try {
          // Check if email already exists
          const { data: existingAgent, error: checkError } = await supabase
            .from("agents")
            .select("id")
            .eq("email", email)
            .maybeSingle();

          if (checkError) {
            throw new Error("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ");
          }

          if (existingAgent) {
            showAlert("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„", "error");
            return;
          }

          // Check if phone already exists
          const { data: existingPhone, error: phoneCheckError } = await supabase
            .from("agents")
            .select("id")
            .eq("phone", phone)
            .maybeSingle();

          if (phoneCheckError) {
            throw new Error("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");
          }

          if (existingPhone) {
            showAlert("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„", "error");
            return;
          }

          // Create new agent
          const { data: newAgent, error: insertError } = await supabase
            .from("agents")
            .insert([
              {
                name: name,
                email: email,
                phone: phone,
                role: role,
                password: password, // In production, you should hash this
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
              }
            ])
            .select()
            .single();

          if (insertError) {
            throw new Error("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: " + insertError.message);
          }

          // Success
          showAlert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…...", "success");
          
          // Clear form
          form.reset();
          strengthBar.className = "password-strength-bar";

          // Redirect to admin dashboard after 2 seconds
          setTimeout(() => {
            window.location.href = "./admin-dashboard.html";
          }, 2000);

        } catch (error) {
          console.error("Registration error:", error);
          showAlert(error.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰", "error");
        } finally {
          setLoading(false);
        }
      });

      // Helper functions
      function showAlert(message, type) {
        alertBox.textContent = message;
        alertBox.className = `alert ${type}`;
        alertBox.style.display = "block";
      }

      function hideAlert() {
        alertBox.style.display = "none";
      }

      function setLoading(isLoading) {
        registerBtn.disabled = isLoading;
        loading.style.display = isLoading ? "inline-block" : "none";
        registerBtn.textContent = isLoading ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡..." : "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯";
        if (isLoading) {
          registerBtn.appendChild(loading);
        }
      }

      // Auto-focus on first field
      document.getElementById("name").focus();
    </script>
  </body>
</html>
