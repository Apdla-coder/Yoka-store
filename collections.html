<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>تحصيل العملاء - فوكس بيزنيس</title>
  <meta name="theme-color" content="#2c3e50" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- PWA Meta Tags -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="فوكس بيزنيس" />
  <meta name="application-name" content="فوكس بيزنيس" />
  <meta name="description" content="نظام متقدم لإدارة التحصيل والمتابعة العملاء" />
  <meta name="msapplication-TileColor" content="#2c3e50" />
  <meta name="msapplication-config" content="./browserconfig.xml" />

  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json" />

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="./Orange_logo.svg.png" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="./Orange_logo.svg.png" />

  <link rel="icon" type="image/x-icon" href="./Orange_logo.svg.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ⚡️ الأساسات العامة */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #1a252f;
      --secondary-color: #2c5f7c;
      --accent-color: #ff6b35;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-bg: #f8f9fa;
      --white: #ffffff;
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --text-muted: #868e96;
      --text-light: #adb5bd;
      --border-color: #dee2e6;
      --border-light: #e9ecef;
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.12);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.16);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-weight: 400;
      line-height: 1.6;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: var(--text-primary);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* ⚡️ الشريط الجانبي */
    .sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 280px;
      height: 100vh;
      background: var(--white);
      box-shadow: var(--shadow-lg);
      transform: translateX(100%);
      transition: var(--transition);
      z-index: 10000;
      overflow-y: auto;
    }

    .sidebar.active {
      transform: translateX(0);
    }

    .sidebar-header {
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: var(--white);
      padding: 20px;
      text-align: center;
      position: relative;
    }

    .sidebar-close {
      position: absolute;
      left: 15px;
      top: 15px;
      background: none;
      border: none;
      color: var(--white);
      font-size: 24px;
      cursor: pointer;
      transition: var(--transition);
    }

    .sidebar-close:hover {
      transform: rotate(90deg);
    }

    .user-profile {
      text-align: center;
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      font-size: 32px;
      color: var(--white);
    }

    .user-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 5px;
    }

    .user-role {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 400;
    }

    .sidebar-menu {
      padding: 20px 0;
    }

    .menu-item {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      color: var(--text-primary);
      text-decoration: none;
      transition: var(--transition);
      border-right: 3px solid transparent;
      font-weight: 500;
      font-size: 15px;
    }

    .menu-item:hover {
      background: var(--light-bg);
      border-right-color: var(--accent-color);
      color: var(--accent-color);
    }

    .menu-item.active {
      background: linear-gradient(90deg, rgba(255, 107, 53, 0.1), transparent);
      border-right-color: var(--accent-color);
      color: var(--accent-color);
      font-weight: 600;
    }

    .menu-item i {
      width: 25px;
      margin-left: 15px;
      text-align: center;
    }

    /* ⚡️ الهيدر */
    header {
      background: var(--white);
      box-shadow: var(--shadow-md);
      position: sticky;
      top: 0;
      z-index: 1000;
      transition: var(--transition);
    }

    .header-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .menu-toggle {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-dark);
      cursor: pointer;
      transition: var(--transition);
      padding: 8px;
      border-radius: 8px;
    }

    .menu-toggle:hover {
      background: var(--light-bg);
      color: var(--accent-color);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--text-dark);
    }

    .logo img {
      height: 40px;
      border-radius: 8px;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-stats {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .stat-item {
      text-align: center;
      padding: 8px 12px;
      background: var(--light-bg);
      border-radius: 8px;
      min-width: 80px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary-color);
      display: block;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }

    /* ⚡️ المحتوى الرئيسي */
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    h1,
    h2,
    h3 {
      color: var(--white);
      margin-bottom: 20px;
      font-weight: 700;
      line-height: 1.3;
    }

    h1 {
      font-size: 36px;
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
      letter-spacing: -0.5px;
    }

    h2 {
      font-size: 28px;
      margin-bottom: 25px;
    }

    h3 {
      font-size: 22px;
      margin-bottom: 20px;
    }

    /* ⚡️ لوحة الإحصائيات */
    .stats-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--white);
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--shadow-md);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .stat-card-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: var(--white);
    }

    .stat-card-icon.primary {
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
    }

    .stat-card-icon.success {
      background: linear-gradient(45deg, var(--success-color), #2ecc71);
    }

    .stat-card-icon.danger {
      background: linear-gradient(45deg, var(--danger-color), #c0392b);
    }

    .stat-card-icon.warning {
      background: linear-gradient(45deg, var(--warning-color), #e67e22);
    }

    .stat-card-title {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 5px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.2;
    }

    .stat-card-change {
      font-size: 12px;
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: 500;
    }

    .stat-card-change.positive {
      color: var(--success-color);
    }

    .stat-card-change.negative {
      color: var(--danger-color);
    }

    /* ⚡️ شريط البحث والفلترة */
    .search-filter-bar {
      background: var(--white);
      border-radius: 15px;
      padding: 0;
      margin-bottom: 30px;
      box-shadow: var(--shadow-md);
      position: sticky;
      top: 90px;
      z-index: 1111;
    }

    .search-filter-container {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-input-group {
      flex: 1;
      min-width: 250px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 45px 12px 15px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      transition: var(--transition);
      background: var(--white);
      color: var(--text-primary);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent-color);
      background: var(--white);
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }

    .search-input::placeholder {
      color: var(--text-muted);
      font-weight: 400;
    }

    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }

    .filter-dropdown {
      position: relative;
    }

    .filter-menu {
      position: absolute;
      top: 100%;
      left: 0;
      width: 320px;
      max-width: 90vw;
      background: var(--white);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      margin-top: 8px;
      border: 1px solid var(--border-color);
      max-height: 80vh;
      overflow-y: auto;
    }

    .filter-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-light);
      background: var(--light-bg);
      border-radius: 12px 12px 0 0;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .filter-header h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .filter-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 36px;
      min-height: 36px;
      touch-action: manipulation;
      transition: var(--transition);
    }

    .filter-close:hover {
      background: var(--border-light);
      color: var(--text-primary);
    }

    .filter-section {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-light);
    }

    .filter-section:last-child {
      border-bottom: none;
    }

    .filter-section label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-primary);
      font-size: 14px;
    }

    .filter-section input,
    .filter-section select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 16px;
      transition: var(--transition);
      touch-action: manipulation;
    }

    .filter-select:focus,
    .filter-input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }

    .amount-filter {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .amount-filter span {
      color: var(--text-secondary);
      font-weight: 500;
    }

    .amount-filter .filter-input {
      flex: 1;
    }

    .filter-actions {
      display: flex;
      gap: 10px;
      padding: 20px;
      background: var(--light-bg);
      border-radius: 0 0 12px 12px;
      position: sticky;
      bottom: 0;
    }

    .filter-actions .btn {
      flex: 1;
      padding: 14px 20px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      touch-action: manipulation;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--border-light);
      border-color: var(--text-secondary);
    }

    .filter-btn {
      padding: 12px 20px;
      background: var(--white);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .filter-btn:hover {
      border-color: var(--accent-color);
      background: var(--white);
      color: var(--accent-color);
      box-shadow: var(--shadow-sm);
    }

    /* ⚡️ بطاقات العملاء */
    .customers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .customer-card {
      background: var(--white);
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--shadow-md);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .customer-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 4px;
      height: 100%;
      background: var(--accent-color);
      transform: scaleY(0);
      transition: var(--transition);
    }

    .customer-card:hover::before {
      transform: scaleY(1);
    }

    .customer-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
    }

    .customer-card.selected {
      border: 2px solid var(--accent-color);
      background: linear-gradient(135deg, rgba(255, 152, 0, 0.05), rgba(255, 255, 255, 1));
    }

    .customer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .customer-info {
      flex: 1;
    }

    .customer-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 5px;
      line-height: 1.3;
    }

    .customer-phone {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
    }

    .customer-phone a {
      color: var(--info-color);
      text-decoration: none;
      transition: var(--transition);
      font-size: 16px;
    }

    .customer-phone a:hover {
      color: var(--accent-color);
      transform: scale(1.1);
    }

    .customer-amount {
      text-align: center;
      padding: 10px;
      background: var(--light-bg);
      border-radius: 10px;
      min-width: 100px;
    }

    .amount-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 5px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .amount-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-color);
      line-height: 1.2;
    }

    .customer-address {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 400;
      line-height: 1.4;
    }

    .customer-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .action-btn {
      flex: 1;
      padding: 12px 8px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .action-btn.collect {
      background: linear-gradient(45deg, var(--success-color), #2ecc71);
      color: var(--white);
    }

    .action-btn.collect:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
    }

    .action-btn.stop {
      background: linear-gradient(45deg, var(--danger-color), #c0392b);
      color: var(--white);
    }

    .action-btn.stop:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
    }

    .customer-note {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-light);
      border-radius: 8px;
      resize: vertical;
      min-height: 60px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 400;
      transition: var(--transition);
      color: var(--text-primary);
      background: var(--white);
    }

    .customer-note:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }

    .customer-note::placeholder {
      color: var(--text-muted);
      font-weight: 400;
    }

    .note-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .note-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
      font-size: 14px;
      font-weight: 500;
      background: var(--light-bg);
      color: var(--text-primary);
    }

    .note-btn:hover {
      background: var(--accent-color);
      color: var(--white);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    /* ⚡️ زر التحصيل السريع */
    .quick-actions {
      margin: 15px 0;
      text-align: center;
    }

    .quick-collect-btn {
      background: linear-gradient(45deg, var(--warning-color), #ff6b35);
      color: var(--white);
      border: none;
      border-radius: 25px;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .quick-collect-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
      background: linear-gradient(45deg, #ff6b35, var(--warning-color));
    }

    .quick-collect-btn:active {
      transform: translateY(0);
    }

    /* ⚡️ تفعيل زر التحصيل السريع عند التحديد */
    .customer-card.selected .quick-actions {
      display: block !important;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ⚡️ زر التحصيل الجماعي العائم */
    .floating-bulk-collect {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(45deg, var(--success-color), #2ecc71);
      border-radius: 25px;
      box-shadow: 0 8px 24px rgba(40, 167, 69, 0.4);
      z-index: 1000;
      animation: slideUp 0.3s ease-out;
      transition: var(--transition);
    }

    .floating-bulk-collect:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 32px rgba(40, 167, 69, 0.5);
    }

    .bulk-collect-content {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 20px;
      color: var(--white);
    }

    .bulk-collect-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-weight: 600;
    }

    .bulk-collect-info span:first-child {
      font-size: 20px;
      font-weight: 700;
    }

    .bulk-collect-info span:last-child {
      font-size: 12px;
      opacity: 0.9;
    }

    .bulk-collect-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid var(--white);
      color: var(--white);
      border-radius: 20px;
      padding: 10px 20px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .bulk-collect-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .bulk-collect-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: var(--white);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .bulk-collect-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .floating-bulk-collect {
        bottom: 20px;
        right: 20px;
        left: 20px;
        border-radius: 15px;
      }

      .bulk-collect-content {
        padding: 12px 15px;
        gap: 10px;
      }

      .bulk-collect-info span:first-child {
        font-size: 18px;
      }

      .bulk-collect-btn {
        padding: 8px 15px;
        font-size: 13px;
      }
    }

    .customer-checkbox {
      position: absolute;
      top: 15px;
      left: 15px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    /* ⚡️ عرض الجدول */
    .table-view {
      background: var(--white);
      border-radius: 15px;
      padding: 20px;
      box-shadow: var(--shadow-md);
      overflow-x: auto;
      display: block;
    }

    .modern-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .modern-table th {
      background: var(--light-bg);
      padding: 15px;
      text-align: right;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-color);
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .modern-table td {
      padding: 15px;
      text-align: right;
      border-bottom: 1px solid var(--border-light);
      color: var(--text-primary);
      font-weight: 400;
      font-size: 14px;
    }

    .modern-table tr:hover {
      background: rgba(255, 152, 0, 0.05);
    }

    .table-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .table-action-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
      font-size: 12px;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* ⚡️ التبويبات الموحدة */
    .unified-tabs {
      display: flex;
      gap: 10px;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 12px 20px;
      background: var(--light-bg);
      border: none;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 3px solid transparent;
    }

    .tab-btn:hover {
      background: var(--border-light);
      color: var(--text-primary);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-in-out;
      min-height: 200px;
    }

    .tab-content.active {
      display: block !important;
    }

    /* ⚡️ Section Header */
    .section-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: var(--white);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
    }

    .section-header h2 {
      margin: 0 0 8px 0;
      font-size: 24px;
      font-weight: 600;
    }

    .section-header p {
      margin: 0;
      font-size: 14px;
      opacity: 0.9;
    }

    .tab-content .table-view {
      display: block !important;
    }

    .tab-content .modern-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--white);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .tab-content .modern-table th {
      background: var(--light-bg);
      padding: 15px;
      text-align: right;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-color);
    }

    .tab-content .modern-table td {
      padding: 12px 15px;
      text-align: right;
      border-bottom: 1px solid var(--border-light);
      color: var(--text-primary);
    }

    .tab-content .modern-table tr:hover {
      background: rgba(255, 152, 0, 0.05);
    }

    /* ⚡️ Status Badges */
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
    }

    .status-badge.pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .status-badge.approved {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-badge.rejected {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ⚡️ الأزرار العامة */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      letter-spacing: 0.3px;
    }

    .btn-primary {
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: var(--white);
    }

    .btn-success {
      background: linear-gradient(45deg, var(--success-color), #2ecc71);
      color: var(--white);
    }

    .btn-danger {
      background: linear-gradient(45deg, var(--danger-color), #c0392b);
      color: var(--white);
    }

    .btn-warning {
      background: linear-gradient(45deg, var(--warning-color), #e67e22);
      color: var(--white);
    }

    .btn-info {
      background: linear-gradient(45deg, var(--info-color), #2980b9);
      color: var(--white);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn:active {
      transform: translateY(0);
    }

    /* ⚡️ الأكورديون */
    .accordion {
      background: var(--white);
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md);
      overflow: hidden;
    }

    .accordion-header {
      width: 100%;
      padding: 20px;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: var(--white);
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      text-align: right;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: var(--transition);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      letter-spacing: 0.3px;
    }

    .accordion-header:hover {
      opacity: 0.9;
    }

    .accordion-header i {
      transition: var(--transition);
    }

    .accordion-header.active i {
      transform: rotate(180deg);
    }

    .accordion-body {
      padding: 20px;
      border-top: 1px solid var(--border-color);
      display: none;
    }

    .accordion-body.active {
      display: block;
    }

    /* ⚡️ الاستجابة للشاشات الصغيرة */
    @media (max-width: 768px) {
      .sectionsGridMain {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }

      .sidebar {
        width: 100%;
      }

      .header-container {
        flex-direction: column;
        gap: 15px;
      }

      .header-stats {
        flex-wrap: wrap;
        justify-content: center;
      }

      .stats-dashboard {
        grid-template-columns: 1fr;
      }

      .customers-grid {
        grid-template-columns: 1fr;
      }

      .search-filter-container {
        flex-direction: row;
      }

      .search-input-group {
        width: 100%;
      }

      .customer-card {
        padding: 15px;
      }

      .customer-actions {
        flex-direction: column;
        gap: 8px;
      }

      .btn {
        padding: 10px 16px;
        font-size: 14px;
        touch-action: manipulation;
      }

      .customer-card {
        margin-bottom: 15px;
      }

      .modern-table {
        font-size: 14px;
      }

      .modern-table th,
      .modern-table td {
        padding: 8px 4px;
      }

      h1 {
        font-size: 24px;
      }

      .filter-menu {
        width: 90vw;
        max-width: 320px;
        left: 100%;
        transform: translateX(-50%);
        max-height: 80vh;
        overflow-y: auto;
      }

      .filter-section {
        padding: 15px;
      }

      .filter-actions {
        padding: 15px;
        flex-direction: column;
      }

      .amount-filter {
        flex-direction: column;
        gap: 8px;
      }

      .amount-filter span {
        text-align: center;
      }
    }

    @media (max-width: 480px) {
      .main-container {
        padding: 10px;
      }

      .filter-menu {
        width: 200px;
        max-width: none;
        top: 60px;
        max-height: 85vh;
        border-radius: 10px;
      }

      .stat-card {
        padding: 15px;
        margin-bottom: 10px;
      }

      .stat-card-value {
        font-size: 24px;
      }

      .customer-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .customer-amount {
        width: 100%;
      }

      .btn {
        padding: 12px 20px;
        font-size: 16px;
        min-height: 44px;
        touch-action: manipulation;
      }

      .customer-actions {
        gap: 10px;
      }

      .modern-table {
        font-size: 12px;
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .modern-table th,
      .modern-table td {
        padding: 6px 2px;
        white-space: nowrap;
      }

      .modal-content {
        width: 95%;
        margin: 5% auto;
        max-height: 90vh;
        overflow-y: auto;
      }

      .sidebar {
        width: 100%;
        height: 100vh;
      }

      .search-input {
        font-size: 16px;
        /* Prevents zoom on iOS */
      }
    }

    /* ⚡️ الرسالة التحفيزية */
    .motivational-toast {
      position: fixed;
      top: 100px;
      left: 20px;
      background: linear-gradient(45deg, var(--accent-color), var(--warning-color));
      color: var(--white);
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      z-index: 10000;
      transform: translateX(-400px);
      transition: var(--transition);
      max-width: 300px;
      font-weight: bold;
      text-align: center;
    }

    .motivational-toast.show {
      transform: translateX(0);
    }

    /* ⚡️ التحميل */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      backdrop-filter: blur(5px);
    }

    .loading-overlay.active {
      display: flex;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid var(--white);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* ⚡️ زر العودة للأعلى */
    .scroll-to-top {
      position: fixed;
      bottom: 30px;
      left: 30px;
      width: 50px;
      height: 50px;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: var(--white);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: var(--shadow-lg);
      transition: var(--transition);
      z-index: 1000;
    }

    .scroll-to-top:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .scroll-to-top.show {
      display: flex;
    }

    /* ⚡️ الفوتر */
    footer {
      background: var(--white);
      color: var(--text-primary);
      text-align: center;
      padding: 20px;
      margin-top: 40px;
      border-radius: 15px 15px 0 0;
      box-shadow: var(--shadow-md);
    }

    footer div {
      margin-bottom: 5px;
      font-weight: 500;
      font-size: 14px;
    }

    footer div:last-child {
      margin-bottom: 0;
      color: var(--text-secondary);
      font-size: 13px;
    }

    /* ⚡️ الأزرار القديمة (للتوافق) */
    button {
      padding: 10px 16px;
      background: var(--success-color);
      border: none;
      color: var(--white);
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s ease;
    }

    button:hover {
      background: #1e8449;
    }

    button.red {
      background: #e74c3c;
    }

    button.red:hover {
      background: #c0392b;
    }

    button.gray {
      background: #bdc3c7;
      cursor: not-allowed;
    }

    /* ⚡️ المودال */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 111111111111111111;
      animation: fadeIn 0.3s ease-in-out;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--white);
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease-in-out;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: var(--white);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: var(--white);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .modal-body {
      padding: 20px;
      max-height: calc(90vh - 80px);
      overflow-y: auto;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ⚡️ الملاحظات */
    textarea {
      width: 100%;
      min-width: 150px;
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 13px;
    }

    /* ⚡️ الرسالة الجماعية */
    #bulkSMSContainer {
      padding: 20px;
      background: #f9f9f9;
      border-radius: 10px;
      max-width: 1000px;
      margin: 20px auto;
      text-align: right;
      box-shadow: 0px 4px 18px rgba(0, 0, 0, 0.1);
    }

    #bulkMessageText {
      width: 100%;
      height: 100px;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    #sendBulkSMS {
      padding: 12px 20px;
      font-size: 14px;
      border-radius: 5px;
      border: none;
      background: #3498db;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
    }

    #sendBulkSMS:hover {
      background: #297fb8;
    }

    /* ⚡️ شريط البحث */
    #searchBarContainer {
      position: sticky;
      top: 0;
      z-index: 1000;
      background-color: #fff;
      padding: 15px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      box-shadow: 0px 3px 12px rgba(0, 0, 0, 0.1);
    }

    #searchInput {
      padding: 12px;
      flex: 1;
      max-width: 300px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    #searchButton {
      padding: 12px 20px;
      font-size: 14px;
      border-radius: 8px;
      font-weight: bold;
      background: #27ae60;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    #searchButton:hover {
      background: #1e8449;
    }

    /* ⚡️ رأس الصفحة */
    header {
      background: linear-gradient(45deg, #2c3e50, #4ca1af);
      padding: 15px 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #fff;
      box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.25);
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
    }

    header h2 {
      margin: 0;
      font-size: 22px;
      font-weight: bold;
    }

    header .logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    header .logo img {
      height: 50px;
      border-radius: 8px;
    }

    /* ⚡️ لودينج */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.3);
    }

    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #27ae60;
      border-radius: 50%;
      width: 55px;
      height: 55px;
      animation: spin 1s linear infinite;
    }

    .accordion {
      width: 90%;
      max-width: 1100px;
      margin: 20px auto;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .accordion-header {
      width: 100%;
      padding: 15px 20px;
      text-align: right;
      background: #34495e;
      color: white;
      font-size: 16px;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }

    .accordion-body {
      background: #fff;
      padding: 10px 15px;
      border-top: 1px solid #ccc;
    }

    @keyframes spin {
      100% {
        transform: rotate(360deg);
      }
    }
  </style>
  <style>
    /* Mobile Responsive Design */
    @media (max-width: 768px) {
      .customers-cards-grid {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
        padding: 0 5px !important;
      }

      .customer-card {
        min-height: 320px !important;
        padding: 12px !important;
        border-radius: 8px !important;
      }

      .customer-header h4 {
        font-size: 14px !important;
      }

      .customer-header p {
        font-size: 12px !important;
      }

      .customer-details span {
        font-size: 11px !important;
      }

      .customer-actions button {
        padding: 6px 4px !important;
        font-size: 11px !important;
        border-radius: 4px !important;
      }

      .customer-secondary-actions button {
        padding: 4px 2px !important;
        font-size: 9px !important;
        border-radius: 3px !important;
      }

      .customer-secondary-actions button span {
        display: inline !important;
      }

      .customer-secondary-actions button i {
        font-size: 12px !important;
      }

      textarea {
        min-height: 40px !important;
        padding: 6px !important;
        font-size: 11px !important;
      }

      .status-badge {
        padding: 2px 6px !important;
        font-size: 10px !important;
      }
    }

    @media (max-width: 480px) {
      .customers-cards-grid {
        grid-template-columns: 1fr !important;
        gap: 8px !important;
        padding: 0 3px !important;
      }

      .customer-card {
        min-height: 300px !important;
        padding: 10px !important;
      }

      .customer-header h4 {
        font-size: 13px !important;
      }

      .customer-details span {
        font-size: 10px !important;
      }

      .customer-actions {
        grid-template-columns: 1fr 1fr !important;
        gap: 4px !important;
      }

      .customer-secondary-actions {
        grid-template-columns: 1fr 1fr 1fr !important;
        gap: 3px !important;
      }
    }
  </style>
</head>

<body>
  <!-- ⚡️ الشريط الجانبي -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <button class="sidebar-close" onclick="toggleSidebar()">
        <i class="fas fa-times"></i>
      </button>
      <h3>لوحة التحكم</h3>
    </div>

    <div class="user-profile">
      <div class="user-avatar">
        <i class="fas fa-user"></i>
      </div>
      <div class="user-name" id="userName">مندوب تحصيل</div>
      <div class="user-role">محصل</div>
    </div>

    <nav class="sidebar-menu">
      <a href="./collections.html" class="menu-item active">
        <i class="fas fa-coins"></i>
        <span>التحصيلات</span>
      </a>
      <a href="#" class="menu-item" onclick="openModal('period')">
        <i class="fas fa-calendar-alt"></i>
        <span>فترة التحصيل</span>
      </a>
      <a href="#" class="menu-item" onclick="openModal('collected')">
        <i class="fas fa-check-circle"></i>
        <span>العملاء المحصلين</span>
      </a>
      <a href="#" class="menu-item" onclick="openModal('stopped')">
        <i class="fas fa-ban"></i>
        <span>طلبات وقف الخدمة</span>
      </a>
      <a href="#" class="menu-item" onclick="openModal('notes')">
        <i class="fas fa-sticky-note"></i>
        <span>ملاحظات العملاء</span>
      </a>
      <a href="#" class="menu-item" onclick="openModal('bulk')">
        <i class="fas fa-users"></i>
        <span>التحصيل الجماعي</span>
      </a>
      <a href="#" class="menu-item" onclick="openModal('stats')">
        <i class="fas fa-chart-bar"></i>
        <span>لوحة الإحصائيات</span>
      </a>
      <a href="#" class="menu-item" onclick="reassignAllCustomers()" style="color: #ffc107;">
        <i class="fas fa-magic"></i>
        <span>نقل العملاء إليّ (مؤقت)</span>
      </a>
      <a href="#" class="menu-item" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        <span>تسجيل الخروج</span>
      </a>
    </nav>
  </aside>

  <!-- ⚡️ مودال التبويبات -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 id="modalTitle">المحتوى</h3>
        <button class="modal-close" onclick="closeModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- المحتوى سيتم تحميله ديناميكياً -->
      </div>
    </div>
  </div>

  <!-- ⚡️ زر التحصيل الجماعي العائم -->
  <div id="floatingBulkCollect" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: none;">
    <button class="btn btn-success"
      style="padding: 15px 20px; border-radius: 50px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); font-size: 16px; font-weight: bold; min-width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; gap: 8px;"
      onclick="event.stopPropagation(); showBulkCollectInterface()">
      <i class="fas fa-users"></i>
      <span id="floatingSelectedCount">0</span>
    </button>
  </div>

  <!-- ⚡️ نافذة التحميل -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>جاري التحميل...</p>
    </div>
  </div>


  <!-- ⚡️ الهيدر -->
  <header>
    <div class="header-container">
      <div class="header-left">
        <button class="menu-toggle" onclick="toggleSidebar()">
          <i class="fas fa-bars"></i>
        </button>
        <a href="./index.html" class="logo">
          <img src="./Orange_logo.svg.png" alt="Logo">
          <span class="logo-text">فوكس بيزنيس</span>
        </a>
      </div>

      <div class="header-right">
        <div class="header-stats">
          <div class="stat-item">
            <div class="stat-value" id="headerTotalDue">0</div>
            <div class="stat-label">المتبقي</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="headerCollected">0</div>
            <div class="stat-label">المحصل</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="headerCustomers">0</div>
            <div class="stat-label">العملاء</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- ⚡️ المحتوى الرئيسي -->
  <main class="main-container">
    <h1>نظام إدارة التحصيل</h1>

    <!-- ⚡️ شريط البحث والفلترة -->
    <div class="search-filter-bar">
      <div class="search-filter-container">
        <div class="search-input-group">
          <input type="text" class="search-input" id="searchInput" placeholder="ابحث بالاسم أو الرقم...">
          <i class="fas fa-search search-icon"></i>
        </div>

        <div class="filter-dropdown">
          <button class="filter-btn" onclick="toggleFilter()">
            <i class="fas fa-filter"></i>
            <span>فلترة</span>
          </button>

          <!-- ⚡️ قائمة الفلترة -->
          <div id="filterDropdown" class="filter-menu" style="display: none;">
            <div class="filter-header">
              <h4>خيارات الفلترة</h4>
              <button class="filter-close" onclick="toggleFilter()">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <div class="filter-section">
              <label for="sectionFilter">القسم:</label>
              <select id="sectionFilter" class="filter-select" onchange="applyFilters()">
                <option value="">جميع الأقسام</option>
              </select>
            </div>

            <div class="filter-section">
              <label for="customerNameFilter">اسم العميل:</label>
              <input type="text" id="customerNameFilter" class="filter-input" placeholder="ابحث باسم العميل..."
                onchange="applyFilters()">
            </div>

            <div class="filter-section">
              <label for="statusFilter">الحالة:</label>
              <select id="statusFilter" class="filter-select" onchange="applyFilters()">
                <option value="">جميع الحالات</option>
                <option value="pending">لم يتم التحصيل</option>
                <option value="collected">تم التحصيل</option>
              </select>
            </div>

            <div class="filter-actions">
              <button class="btn btn-secondary" onclick="clearFilters()">
                <i class="fas fa-undo"></i>
                مسح الفلاتر
              </button>
              <button class="btn btn-primary" onclick="applyFilters()">
                <i class="fas fa-check"></i>
                تطبيق
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ⚡️ محتوى التبويبات -->
    <div class="tab-content active" id="collectedTab">
      <div class="section-header">
        <h2>التحصيلات</h2>
        <p>إدارة وتحصيل مبالغ العملاء المستحقة</p>
      </div>

      <!-- عرض الأقسام -->
      <div id="sectionsDisplay" style="margin-bottom: 30px;">
        <h3 style="margin: 0 0 20px 0; color: var(--primary-color);">الأقسام</h3>
        <div class="sectionsGridMain" id="sectionsGridMain"
          style="display: grid; grid-template-rows: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
          <!-- سيتم ملؤها ديناميكياً -->
        </div>
      </div>


    </div>

    <!-- ⚡️ رسالة تحفيزية -->
    <div class="motivational-toast" id="motivationalToast"></div>

  </main>

  <!-- ⚡️ زر العودة للأعلى -->
  <button class="scroll-to-top" id="scrollToTopBtn" onclick="scrollToTop()">
    <i class="fas fa-arrow-up"></i>
  </button>

  <!-- ⚡️ الفوتر -->
  <footer>
    <div>جميع الحقوق محفوظة &copy; فوكس بيزنيس</div>
    <div>مطور النظام: عبدالله هاني</div>
    <div>خدمة العملاء: 01220200747</div>
  </footer>

  <!-- ⚡️ شاشة التحميل -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <script type="module">
    // Version: 2.1 - Fixed JavaScript errors
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://inguuoiolmbplubkwcvd.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImluZ3V1b2lvbG1icGx1Ymt3Y3ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1MDIxMjksImV4cCI6MjA4NjA3ODEyOX0.wRTnc2LRoy4d77K7RWOeglfsO51kCfN3NlRB7UvyD4Y"
    );

    let customersData = [];
    let currentView = 'cards';
    let filteredData = [];
    let collectionAmounts = {};

    // ⚡️ دالة حساب المبلغ المستحق (موحدة مع لوحة الإدارة)
    function calculateAmount(customer) {
      if (customer.collection_status === 'تم التحصيل') return 0;
      // إذا كان تحصيل جزئي، نعتمد على المتبقي المسجل في debt_amount
      if (customer.collection_status === 'تحصيل جزئي') return parseFloat(customer.debt_amount || 0) || 0;

      const pkg = parseFloat(customer.package_price || 0) || 0;
      const debt = parseFloat(customer.debt_amount || 0) || 0;
      const due = parseFloat(customer.due_amount || 0) || 0;
      return pkg + debt + due;
    }

    // ⚡️ إنشاء المودال إذا لم يكن موجوداً
    function createModalIfNotExists() {
      // Check if all essential modal elements exist
      const modalOverlay = document.getElementById('modalOverlay');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      if (modalOverlay && modalTitle && modalBody) {
        console.log('✅ Modal elements already exist');
        return;
      }

      console.log('Recreating or fixing modal elements...');

      // If overlay exists but sub-elements are missing, we should probably clear it and recreate or just fix it
      if (modalOverlay) {
        modalOverlay.remove();
      }

      // Create modal HTML
      const modalHTML = `
            <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
              <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                  <h3 id="modalTitle">المحتوى</h3>
                  <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <div class="modal-body" id="modalBody">
                  <!-- المحتوى سيتم تحميله ديناميكاً -->
                </div>
              </div>
            </div>
          `;

      // Add to body
      document.body.insertAdjacentHTML('beforeend', modalHTML);

      // Verify modal was created
      if (document.getElementById('modalOverlay') && document.getElementById('modalTitle') && document.getElementById('modalBody')) {
        console.log('✅ Modal created successfully with all elements');
      } else {
        console.error('❌ Failed to create complete modal structure');
      }
    }

    // ⚡️ دوال الواجهة الحديثة
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('active');
    };

    // ⚡️ فتح المودال
    function openModal(tabType) {
      // إغلاق السايد بار أولاً
      const sidebar = document.getElementById('sidebar');
      if (sidebar) {
        sidebar.classList.remove('active');
      }

      // Get modal elements
      const modalOverlay = document.getElementById('modalOverlay');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      // Check if modal elements exist
      if (!modalOverlay || !modalTitle || !modalBody) {
        console.error('Modal elements not found, creating modal...');
        createModalIfNotExists();

        // Retry immediately after creation
        setTimeout(() => openModal(tabType), 100);
        return;
      }

      // تحديث العنوان
      const titles = {
        'period': 'فترة التحصيل',
        'collected': 'العملاء المحصلين',
        'stopped': 'طلبات وقف الخدمة',
        'notes': 'ملاحظات العملاء',
        'bulk': 'التحصيل الجماعي',
        'stats': 'لوحة الإحصائيات'
      };

      if (modalTitle) {
        modalTitle.textContent = titles[tabType] || 'المحتوى';
      } else {
        console.error('Modal title element not found');
        return;
      }

      // تحميل المحتوى حسب نوع التبويب
      switch (tabType) {
        case 'period':
          loadPeriodModal();
          break;
        case 'collected':
          loadCollectedModal();
          break;
        case 'stopped':
          loadStoppedModal();
          break;
        case 'notes':
          loadNotesModal();
          break;
        case 'bulk':
          loadBulkModal();
          break;
        case 'stats':
          loadStatsModal();
          break;
      }

      // إظهار المودال
      modalOverlay.classList.add('active');
    };

    // ⚡️ إغلاق المودال
    function closeModal() {
      console.log("🔒 إغلاق المودال...");

      // إزالة الكلاس active بدلاً من حذف العنصر من الـ DOM
      const modalOverlay = document.getElementById('modalOverlay');
      if (modalOverlay) {
        modalOverlay.classList.remove('active');
      }

      // Also check for any other modals (like the grouped customers one)
      const groupedModal = document.getElementById('groupedCustomersModal');
      if (groupedModal) {
        groupedModal.classList.remove('active');
        // For the specific grouped modal which is created ad-hoc, we can remove it or just hide it
        setTimeout(() => {
          if (groupedModal && !groupedModal.classList.contains('active')) {
            groupedModal.remove();
          }
        }, 300);
      }

      console.log("✅ تم إخفاء المودال");
    };

    // ⚡️ تحميل مودال فترة التحصيل
    function loadPeriodModal() {
      const modalBody = document.getElementById('modalBody');

      let html = `
            <div style="padding: 20px;">
              <!-- حالة فترة التحصيل الحالية -->
              <div class="collection-period-status" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <h4 style="margin: 0 0 0.5rem 0; font-size: 1.2rem;">📅 فترة التحصيل الحالية</h4>
                    <p id="modalCurrentPeriodInfo" style="margin: 0; font-size: 0.9rem; opacity: 0.9;">جاري تحميل معلومات الفترة...</p>
                  </div>
                  <div style="text-align: left;">
                    <div style="font-size: 0.8rem; opacity: 0.8;">العملاء المتأخرين</div>
                    <div id="modalOverdueCustomersCount" style="font-size: 1.5rem; font-weight: bold; color: #ffc107;">0</div>
                  </div>
                </div>
              </div>
              
              <!-- إحصائيات الفترة -->
              <div id="periodStats" style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px;">
                <h4 style="margin: 0 0 1rem 0; color: #333;">📊 إحصائيات الفترة</h4>
                <div id="periodStatsContent" style="text-align: center; color: #666;">
                  جاري تحميل الإحصائيات...
                </div>
              </div>
            </div>
          `;

      modalBody.innerHTML = html;

      // تحديث بيانات الفترة
      updateCollectionPeriodStatus();
      updatePeriodStats();
    }

    // ⚡️ تحميل مودال العملاء المحصلين
    function loadCollectedModal() {
      const modalBody = document.getElementById('modalBody');
      const collected = customersData.filter(c => c.collection_status === "تم التحصيل");

      let html = `
            <div style="margin-bottom: 15px;">
              <div style="background: var(--light-bg); padding: 10px; border-radius: 8px; text-align: center;">
                <strong>إجمالي المحصلين: ${collected.length}</strong>
              </div>
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: var(--light-bg);">
                    <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">الاسم</th>
                    <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">المبلغ</th>
                    <th style="padding: 8px; text-align: right; border: 1px solid var(--border-color);">إجراء</th>
                  </tr>
                </thead>
                <tbody>
          `;

      collected.forEach(customer => {
        // For collected customers, show actual collected amount from collections table
        // prefer recorded collection amount, otherwise use full display_amount (package+debts)
        // prefer recorded collection amount but never be less than the customer's display amount (full due)
        const recordedAmt = parseFloat(collectionAmounts[customer.id] || 0) || 0;
        const displayAmt = parseFloat(customer.display_amount || 0) || 0;
        const packageAmt = parseFloat(customer.package_price || 0) || 0;
        const otherAmt = parseFloat(customer.amount || 0) || 0;
        const amount = Math.max(recordedAmt, displayAmt, packageAmt, otherAmt);
        html += `
                  <tr>
                    <td style="padding: 8px; border: 1px solid var(--border-color);">${customer.name || customer.customer_name || 'غير معروف'}</td>
                    <td style="padding: 8px; border: 1px solid var(--border-color);">${amount} ج.م</td>
                    <td style="padding: 8px; border: 1px solid var(--border-color);">
                      <button class="btn btn-sm btn-primary" onclick="viewCustomerDetails('${customer.id}')" style="margin-left: 5px;">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn btn-sm btn-warning" onclick="rollbackCollection('${customer.id}', '${customer.name || customer.customer_name}')" title="تراجع عن التحصيل">
                        <i class="fas fa-undo"></i>
                      </button>
                    </td>
                  </tr>
            `;
      });

      html += `
                </tbody>
              </table>
            </div>
          `;

      modalBody.innerHTML = html;
    }

    // ⚡️ تحميل مودال طلبات الوقف
    function loadStoppedModal() {
      const modalBody = document.getElementById('modalBody');
      const stoppedRequests = window.stoppedRequestsData || [];

      if (stoppedRequests.length === 0) {
        modalBody.innerHTML = '<p style="text-align: center; padding: 20px;">لا توجد طلبات وقف حالياً</p>';
        return;
      }

      let html = `
            <div style="overflow-x: auto;">
              <table class="modern-table">
                <thead>
                  <tr>
                    <th>اسم العميل</th>
                    <th>الموبايل</th>
                    <th>السبب</th>
                    <th>التاريخ</th>
                    <th>الحالة</th>
                  </tr>
                </thead>
                <tbody>
          `;

      stoppedRequests.forEach(request => {
        html += `
              <tr>
                <td>${request.customer_name || 'غير محدد'}</td>
                <td>${request.customer_phone || 'غير محدد'}</td>
                <td>${request.reason || 'غير محدد'}</td>
                <td>${new Date(request.created_at).toLocaleDateString('ar-EG')}</td>
                <td><span class="status-badge pending">${request.status || 'معلق'}</span></td>
              </tr>
            `;
      });

      html += `
                </tbody>
              </table>
            </div>
          `;

      modalBody.innerHTML = html;
    }

    // ⚡️ تحميل مودال الملاحظات
    function loadNotesModal() {
      const modalBody = document.getElementById('modalBody');
      const customerNotes = window.customerNotesData || [];

      if (customerNotes.length === 0) {
        modalBody.innerHTML = '<p style="text-align: center; padding: 20px;">لا توجد ملاحظات حالياً</p>';
        return;
      }

      let html = `
            <div style="overflow-x: auto;">
              <table class="modern-table">
                <thead>
                  <tr>
                    <th>اسم العميل</th>
                    <th>الموبايل</th>
                    <th>الملاحظة</th>
                    <th>التاريخ</th>
                    <th>إجراءات</th>
                  </tr>
                </thead>
                <tbody>
          `;

      customerNotes.forEach(note => {
        html += `
              <tr>
                <td>${note.customer_name || 'غير محدد'}</td>
                <td>${note.customer_phone || 'غير محدد'}</td>
                <td>${note.note_text || note.note || 'غير محدد'}</td>
                <td>${new Date(note.created_at).toLocaleDateString('ar-EG')}</td>
                <td>
                  <button class="btn btn-danger btn-sm" onclick="deleteNote('${note.id}', '${note.customer_name}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            `;
      });

      html += `
                </tbody>
              </table>
            </div>
          `;

      modalBody.innerHTML = html;
    }

    // ⚡️ تحميل مودال لوحة الإحصائيات
    function loadStatsModal() {
      const modalBody = document.getElementById('modalBody');
      const agent_id = localStorage.getItem("agent_id");

      // حساب الإحصائيات
      const totalCustomers = customersData.length;
      const collectedCustomers = customersData.filter(c => c.collection_status === "تم التحصيل").length;
      const pendingCustomers = totalCustomers - collectedCustomers;
      const totalCollected = customersData
        .filter(c => c.collection_status === "تم التحصيل")
        .reduce((sum, c) => {
          const rec = parseFloat(collectionAmounts[c.id] || 0) || 0;
          const disp = parseFloat(c.display_amount || 0) || 0;
          const pkg = parseFloat(c.package_price || 0) || 0;
          const oth = parseFloat(c.amount || 0) || 0;
          return sum + Math.max(rec, disp, pkg, oth);
        }, 0);
      const pendingAmount = customersData
        .filter(c => c.collection_status !== "تم التحصيل")
        .reduce((sum, c) => sum + (c.display_amount || 0), 0);

      const collectionRate = totalCustomers > 0 ? ((collectedCustomers / totalCustomers) * 100).toFixed(1) : 0;

      // حساب إحصائيات الأقسام
      const sectionsStats = {};
      customersData.forEach(customer => {
        const section = customer.section || 'غير محدد';
        if (!sectionsStats[section]) {
          sectionsStats[section] = {
            total: 0,
            collected: 0,
            amount: 0
          };
        }
        sectionsStats[section].total++;
        // Use display_amount which already includes package price and any due/debt amounts
        const sectionAmount = customer.display_amount || 0;
        sectionsStats[section].amount += sectionAmount;
        if (customer.collection_status === "تم التحصيل") {
          sectionsStats[section].collected++;
        }
      });

      let html = `
            <div style="padding: 20px;">
              <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                  <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${totalCustomers}</div>
                  <div style="font-size: 14px; opacity: 0.9;">إجمالي العملاء</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                  <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${collectedCustomers}</div>
                  <div style="font-size: 14px; opacity: 0.9;">العملاء المحصلين</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                  <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${pendingCustomers}</div>
                  <div style="font-size: 14px; opacity: 0.9;">العملاء المتبقيين</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b, #38f9d7); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                  <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${collectionRate}%</div>
                  <div style="font-size: 14px; opacity: 0.9;">نسبة التحصيل</div>
                </div>
              </div>
              
              <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #fa709a, #fee140); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                  <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${totalCollected} ج.م</div>
                  <div style="font-size: 14px; opacity: 0.9;">إجمالي المحصل</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #30cfd0, #330867); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                  <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${pendingAmount} ج.م</div>
                  <div style="font-size: 14px; opacity: 0.9;">المبلغ المتبقي</div>
                </div>
              </div>
              
              <!-- إحصائيات الأقسام -->
              <div style="background: var(--light-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 15px 0; color: var(--primary-color); text-align: center;">إحصائيات الأقسام</h4>
                <div style="overflow-x: auto;">
                  <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                    <thead>
                      <tr style="background: var(--primary-color); color: white;">
                        <th style="padding: 12px; text-align: right;">القسم</th>
                        <th style="padding: 12px; text-align: right;">إجمالي العملاء</th>
                        <th style="padding: 12px; text-align: right;">العملاء المحصلين</th>
                        <th style="padding: 12px; text-align: right;">نسبة التحصيل</th>
                        <th style="padding: 12px; text-align: right;">إجمالي المبلغ</th>
                      </tr>
                    </thead>
                    <tbody>
          `;

      Object.entries(sectionsStats).forEach(([section, stats]) => {
        const sectionRate = stats.total > 0 ? ((stats.collected / stats.total) * 100).toFixed(1) : 0;
        html += `
                      <tr style="border-bottom: 1px solid var(--border-light);">
                        <td style="padding: 10px; text-align: right;">${section}</td>
                        <td style="padding: 10px; text-align: center;">${stats.total}</td>
                        <td style="padding: 10px; text-align: center;">${stats.collected}</td>
                        <td style="padding: 10px; text-align: center;">
                          <span style="background: ${sectionRate >= 50 ? '#d4edda' : '#f8d7da'}; color: ${sectionRate >= 50 ? '#155724' : '#721c24'}; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                            ${sectionRate}%
                          </span>
                        </td>
                        <td style="padding: 10px; text-align: right; font-weight: bold;">${stats.amount} ج.م</td>
                      </tr>
            `;
      });

      html += `
                    </tbody>
                  </table>
                </div>
              </div>
              
              <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="closeModal()">إغلاق</button>
              </div>
            </div>
          `;

      modalBody.innerHTML = html;
    }

    // ⚡️ تحميل مودال التحصيل الجماعي
    function loadBulkModal() {
      const modalBody = document.getElementById('modalBody');

      let html = `
            <div style="text-align: center; padding: 20px;">
              <h4>التحصيل الجماعي</h4>
              <p style="margin: 20px 0; color: var(--text-secondary);">
                قم بتحديد العملاء الذين تريد تحصيل مبالغهم دفعة واحدة
              </p>
              <button class="btn btn-primary btn-lg" onclick="showBulkCollectInterface()">
                <i class="fas fa-users"></i>
                بدء التحصيل الجماعي
              </button>
            </div>
          `;

      modalBody.innerHTML = html;
    }

    // ⚡️ تحميل بيانات الملاحظات
    async function loadCustomerNotes() {
      const agent_id = localStorage.getItem("agent_id");
      if (!agent_id) return;

      try {
        const { data, error } = await supabase
          .from("agent_notes")
          .select("*")
          .eq("agent_id", agent_id)
          .order("created_at", { ascending: false });

        if (error) {
          console.error("❌ خطأ في تحميل الملاحظات:", error);
          window.customerNotesData = [];
          return;
        }

        console.log("📝 عدد الملاحظات تم تحميلها للتبويب الجانبي:", data?.length || 0);
        window.customerNotesData = data || [];

      } catch (error) {
        console.error("❌ خطأ في تحميل الملاحظات:", error);
        window.customerNotesData = [];
      }
    }

    // ⚡️ تحميل تبويب التحصيل الجماعي
    function loadBulkTab() {
      const sidebarTabBody = document.getElementById('sidebarTabBody');

      let html = `
            <div style="background: linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(46, 204, 113, 0.1)); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(39, 174, 96, 0.2);">
              <h4 style="margin-top: 0; color: var(--success-color); display: flex; align-items: center; gap: 8px; font-size: 16px;">
                <i class="fas fa-info-circle"></i>
                تعليمات التحصيل الجماعي
              </h4>
              <ol style="margin-right: 15px; color: var(--text-primary); line-height: 1.6; font-size: 14px;">
                <li>حدد جميع العملاء الذين تريد تحصيلهم</li>
                <li>سيتم تحصيل المبالغ الموجودة في الشيت تلقائياً</li>
                <li>سيتم تصفير المبلغ بعد التحصيل</li>
                <li>اضغط "تحصيل المحدد" لتحصيل كل العملاء دفعة واحدة</li>
              </ol>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 8px;">
              <button onclick="selectAllCustomers()" style="background: var(--info-color); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                <i class="fas fa-check-square"></i> تحديد الكل
              </button>
              <button onclick="deselectAllCustomers()" style="background: var(--warning-color); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                <i class="fas fa-times-square"></i> إلغاء التحديد
              </button>
              <span id="selectedCount" style="font-weight: bold; color: var(--danger-color); padding: 8px; background: rgba(231, 76, 60, 0.1); border-radius: 6px; font-size: 14px;">
                0 عميل محدد
              </span>
            </div>
            
            <button onclick="bulkCollectCustomers()" style="background: linear-gradient(45deg, var(--success-color), #2ecc71); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; font-weight: 600;">
              <i class="fas fa-coins"></i> تحصيل المحدد (تلقائي)
            </button>
          `;

      sidebarTabBody.innerHTML = html;
    }

    window.setView = function (view) {
      currentView = view;
      console.log('View switched to:', view);
    };

    window.toggleFilter = function () {
      const filterDropdown = document.getElementById('filterDropdown');
      filterDropdown.style.display = filterDropdown.style.display === 'block' ? 'none' : 'block';
    };

    window.scrollToTop = function () {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // ⚡️ مراقبة التمرير لزر العودة للأعلى
    window.addEventListener('scroll', () => {
      const scrollBtn = document.getElementById('scrollToTopBtn');
      if (window.scrollY > 300) {
        scrollBtn.classList.add('show');
      } else {
        scrollBtn.classList.remove('show');
      }
    });

    // ⚡️ إغلاق الشريط الجانبي عند النقر خارجه
    document.addEventListener('click', (e) => {
      const sidebar = document.getElementById('sidebar');
      const menuToggle = document.querySelector('.menu-toggle');

      if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
        sidebar.classList.remove('active');
      }
    });

    // ⚡️ الأكورديون المحسن
    window.toggleAccordion = function (sectionId) {
      const section = document.getElementById(sectionId);
      const header = event.target.closest('.accordion-header');
      const icon = header.querySelector('i');

      section.classList.toggle('active');
      header.classList.toggle('active');

      // Save active section to localStorage for preservation
      if (section.classList.contains('active')) {
        localStorage.setItem('lastActiveSection', sectionId);
      } else {
        localStorage.removeItem('lastActiveSection');
      }

      // إغلاق الأقسام الأخرى
      document.querySelectorAll('.accordion-body').forEach(body => {
        if (body.id !== sectionId) {
          body.classList.remove('active');
        }
      });

      document.querySelectorAll('.accordion-header').forEach(h => {
        if (h !== header) {
          h.classList.remove('active');
        }
      });
    };

    // ⚡️ البحث المحسن
    document.getElementById('searchInput').addEventListener('input', function (e) {
      applyFilters();
    });

    // ⚡️ دوال الفلترة
    function applyFilters(shouldToggle = true) {
      console.log("🔍 تطبيق الفلاتر");

      const searchInput = document.getElementById('searchInput');
      const sectionFilter = document.getElementById('sectionFilter');
      const statusFilter = document.getElementById('statusFilter');

      const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
      const sectionValue = sectionFilter ? sectionFilter.value : '';
      const statusValue = statusFilter ? statusFilter.value : '';

      if (!customersData || customersData.length === 0) {
        console.warn("⚠️ لا توجد بيانات للتصفية");
        return;
      }

      filteredData = customersData.filter(customer => {
        const searchMatch = !searchTerm ||
          (customer.name && customer.name.toLowerCase().includes(searchTerm)) ||
          (customer.phone && customer.phone.includes(searchTerm)) ||
          (customer.address && customer.address.toLowerCase().includes(searchTerm));

        const sectionMatch = !sectionValue ||
          (customer.section && customer.section === sectionValue);

        const statusMatch = !statusValue ||
          (statusValue === 'pending' && customer.collection_status !== "تم التحصيل") ||
          (statusValue === 'collected' && customer.collection_status === "تم التحصيل");

        return searchMatch && sectionMatch && statusMatch;
      });

      // نقوم فقط باستدعاء displaySections لأنه هو العرض المعتمد حالياً ويحتوي على الكروت بداخله
      displaySections(filteredData);
      updateStatistics(filteredData, collectionAmounts);

      if (shouldToggle && typeof toggleFilter === 'function') {
        toggleFilter();
      }
    };

    function clearFilters() {
      console.log("🔄 مسح الفلاتر");

      // Clear filters with null checks
      const searchInput = document.getElementById('searchInput');
      const sectionFilter = document.getElementById('sectionFilter');
      const customerNameFilter = document.getElementById('customerNameFilter');
      const statusFilter = document.getElementById('statusFilter');
      const filterDropdown = document.getElementById('filterDropdown');

      if (searchInput) searchInput.value = '';
      if (sectionFilter) sectionFilter.value = '';
      if (customerNameFilter) customerNameFilter.value = '';
      if (statusFilter) statusFilter.value = '';

      // إعادة تعيين البيانات
      filteredData = customersData;

      // تحديث العرض
      // Always use cards view since table view is removed
      displayCustomersCards(customersData);

      displaySections(customersData);
      updateStatistics(customersData, collectionAmounts);

      // إغلاق قائمة الفلترة
      if (filterDropdown) filterDropdown.style.display = 'none';
    };

    // ⚡️ تحميل الأقسام في قائمة الفلترة
    function loadSections() {
      const sectionFilter = document.getElementById('sectionFilter');

      if (!sectionFilter) {
        console.log('Section filter not found, skipping...');
        return;
      }

      const sections = [...new Set(customersData.map(c => c.section).filter(Boolean))];

      // حفظ الخيار الحالي
      const currentValue = sectionFilter.value;

      // مسح الخيارات الحالية
      sectionFilter.innerHTML = '<option value="">جميع الأقسام</option>';

      // إضافة الأقسام
      sections.forEach(section => {
        const option = document.createElement('option');
        option.value = section;
        option.textContent = section;
        sectionFilter.appendChild(option);
      });

      // استعادة الخيار الحالي
      sectionFilter.value = currentValue;

      console.log("📂 تم تحميل الأقسام:", sections);
    }

    // ⚡️ تحميل فئات الباقات في قائمة الفلترة
    function loadPackageCategories() {
      const packageCategoryFilter = document.getElementById('packageCategoryFilter');

      // Check if element exists (we removed it from filter modal)
      if (!packageCategoryFilter) {
        console.log('Package category filter not found, skipping...');
        return;
      }

      const categories = [...new Set(customersData.map(c => c.package_category).filter(Boolean))];

      // حفظ الخيار الحالي
      const currentValue = packageCategoryFilter.value;

      // مسح الخيارات الحالية
      packageCategoryFilter.innerHTML = '<option value="">جميع الفئات</option>';

      // إضافة الفئات
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        packageCategoryFilter.appendChild(option);
      });

      // استعادة الخيار الحالي
      packageCategoryFilter.value = currentValue;

      console.log("📦 تم تحميل فئات الباقات:", categories);
    }

    // ⚡️ عرض العملاء كبطاقات (العرض الوحيد المتاح)
    function displayCustomersCards(data) {
      console.log("🔄 جاري عرض العملاء كبطاقات، عدد العملاء:", data.length);

      if (!data || data.length === 0) {
        console.log("⚠️ لا توجد بيانات عملاء لهذا المندوب");
        const sectionsGridMain = document.getElementById('sectionsGridMain');
        if (sectionsGridMain) {
          sectionsGridMain.innerHTML = '<div style="text-align: center; padding: 40px; color: white; font-size: 18px;">لا توجد بيانات عملاء حالياً</div>';
        }
        return;
      }

      // Create a simple grid display for customers
      const sectionsGridMain = document.getElementById('sectionsGridMain');
      if (!sectionsGridMain) return;

      let html = '';
      const pending = data.filter(c => c.collection_status !== "تم التحصيل");

      pending.forEach((customer, index) => {
        const name = customer.name || customer.customer_name || 'غير معروف';
        const phone = customer.phone || customer.customer_phone || 'لا يوجد';
        // if display_amount wasn't computed for some reason fall back to the sum of the parts
        const amount = customer.display_amount ||
          (parseFloat(customer.package_price || 0) +
            parseFloat(customer.debt_amount || 0) +
            parseFloat(customer.due_amount || 0));

        html += `
              <div class="customer-card" style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <h3 style="margin: 0; color: var(--primary-color);">${name}</h3>
                  <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                    <span style="background: var(--accent-color); color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold;">${amount} ج.م</span>
                    ${customer.collection_status === 'تحصيل جزئي' ? '<span style="color: #856404; font-size: 11px; font-weight: bold; background: #fff3cd; border: 1px solid #ffeeba; padding: 2px 8px; border-radius: 10px;">سداد جزئي</span>' : ''}
                  </div>
                </div>
                <p style="margin: 5px 0; color: var(--text-secondary);"><i class="fas fa-phone"></i> ${phone}</p>
                <div style="margin-top: 10px;">
                  <label style="font-size: 12px; color: #666; margin-bottom: 5px; display: block;">المبلغ المحصل:</label>
                  <input type="number" id="collectAmount_${customer.id}" value="${amount}" step="0.5" 
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; font-weight: bold; color: var(--accent-color);">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                  <button onclick="const amt = document.getElementById('collectAmount_${customer.id}').value; collect('${customer.id}', '${name.replace(/'/g, "\\'")}', amt)" style="flex: 1; background: var(--success-color); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">تحصيل</button>
                  <button onclick="requestStopService('${customer.id}', '${name.replace(/'/g, "\\'")}', '${phone.replace(/'/g, "\\'")}')" style="flex: 1; background: var(--danger-color); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">أخرى</button>
                </div>
              </div>
            `;
      });

      sectionsGridMain.innerHTML = html;
      console.log("✅ تم عرض جميع العملاء كبطاقات بسيطة");
    }



    // ⚡️ عرض الرسالة التحفيزية المحسنة
    function showRandomMotivationalMessage() {
      const messages = [
        "💪 يوم جديد، تحدٍ جديد! أنت قدها!",
        "🚀 استمر، نجاحك على بعد خطوة!",
        "📈 كل مبلغ بتحصله هو نجاح جديد يُحسب لك!",
        "☕ خذ نفسًا وابدأ من جديد!",
        "🎯 هدفك اليوم: تحقيق أفضل إنجاز!",
        "⭐ أنت محترف، أثبت قدراتك!",
        "🔥 استمر في التميز، النجاح حليفك!"
      ];

      const toast = document.getElementById('motivationalToast');
      const randomMessage = messages[Math.floor(Math.random() * messages.length)];

      toast.textContent = randomMessage;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 8000);
    }

    // ⚡️ تحديث الإحصائيات
    function updateStatistics(data, collectionAmounts = {}) {
      const pending = data.filter(c => c.collection_status !== "تم التحصيل");
      const collected = data.filter(c => c.collection_status === "تم التحصيل");

      console.log("📊 العملاء المتبقي:", pending.length, "العملاء المحصلين:", collected.length);

      // make sure display_amount is the full total (package + debts) so stats always match the "إجمالي المبلغ" value
      const totalDue = pending.reduce((sum, c) => sum + (c.display_amount || 0), 0);
      // Calculate collected amount from collections table (or fall back to the full display amount)
      const totalCollected = collected.reduce((sum, c) => {
        const rec = parseFloat(collectionAmounts[c.id] || 0) || 0;
        const disp = parseFloat(c.display_amount || 0) || 0;
        const pkg = parseFloat(c.package_price || 0) || 0;
        const oth = parseFloat(c.amount || 0) || 0;
        return sum + Math.max(rec, disp, pkg, oth);
      }, 0);
      const completionRate = data.length > 0 ? Math.round((collected.length / data.length) * 100) : 0;

      console.log("💰 المبلغ المتبقي:", totalDue, "المبلغ المحصل:", totalCollected);

      // تحديث البطاقات الموجودة فقط
      const totalDueElement = document.getElementById('totalDue');
      if (totalDueElement) {
        totalDueElement.textContent = `${totalDue.toFixed(2)} ج.م`;
      }

      // تحديث الهيدر إذا كان موجوداً
      const headerTotalDue = document.getElementById('headerTotalDue');
      const headerCollected = document.getElementById('headerCollected');
      const headerCustomers = document.getElementById('headerCustomers');

      if (headerTotalDue) headerTotalDue.textContent = totalDue.toFixed(0);
      if (headerCollected) headerCollected.textContent = totalCollected.toFixed(0);
      if (headerCustomers) headerCustomers.textContent = pending.length;

      console.log("✅ تم تحديث الإحصائيات بنجاح");
    }

    // Create modal immediately when script loads
    createModalIfNotExists();

    // ✅ عند تحميل الصفحة
    // ✅ وظيفة مؤقتة لنقل جميع العملاء للمندوب الحالي (لأغراض الاختبار والتحقق)
    window.reassignAllCustomers = async () => {
      const agent_id = localStorage.getItem("agent_id");
      if (!agent_id) return alert("❌ لا يوجد ID مندوب");

      if (!confirm("⚠️ هل تريد نقل جميع العملاء في القاعدة (144 عميل حالياً) لاسمك لتتمكن من رؤيتهم؟")) return;

      const { data: allCustomers, error: fetchError } = await supabase.from('customers').select('id');
      if (fetchError) return alert("❌ خطأ في جلب العملاء");

      const ids = allCustomers.map(c => c.id);
      const { error: updateError } = await supabase.from('customers').update({ agent_id }).in('id', ids);

      if (updateError) {
        alert("❌ فشل النقل: " + updateError.message);
      } else {
        alert("✅ تم نقل جميع العملاء إليك بنجاح! جاري تحديث الصفحة...");
        window.location.reload();
      }
    };

    window.onload = async () => {
      console.log("🚀 بداية تحميل الصفحة...");

      // تحقق من وجود المستخدم
      const agent_id = localStorage.getItem("agent_id");
      const agent_name = localStorage.getItem("agent_name");
      console.log("👤 بيانات المندوب:", { agent_id, agent_name });

      if (!agent_id) {
        console.error("❌ لا يوجد agent_id في localStorage");
        alert("❌ليس لديك صلاحية");
        window.location.href = './index.html';
        return;
      }

      // تحديث اسم المستخدم
      const userName = agent_name || "مندوب تحصيل";
      document.getElementById('userName').textContent = userName;
      console.log("✅ تم تحديث اسم المستخدم:", userName);

      try {
        await updateLastLoginWithLocation(agent_id);
        console.log("✅ تم تحديث الموقع الجغرافي");

        await loadCustomers(agent_id, true);
        console.log("✅ تم تحميل العملاء");

        await loadStoppedCustomers(agent_id);
        console.log("✅ تم تحميل طلبات الوقف");

        await loadCustomerNotes();
        console.log("✅ تم تحميل ملاحظات العملاء");

        showRandomMotivationalMessage();
        console.log("✅ تم عرض الرسالة التحفيزية");

        // إظهار عرض الأقسام افتراضياً
        const sectionsGrid = document.getElementById('sectionsGridMain');
        if (sectionsGrid) {
          sectionsGrid.style.display = 'grid';
          console.log("✅ تم تفعيل عرض الأقسام");
        } else {
          console.log("ℹ️ لم يتم العثور على عنصر الأقسام");
        }

      } catch (error) {
        console.error("❌ خطأ في تحميل الصفحة:", error);
        alert("⚠️ حدث خطأ أثناء تحميل البيانات: " + error.message);
      }

      console.log("🎉 اكتمل تحميل الصفحة بنجاح");
    };

    // ✅ تحميل بيانات العملاء
    async function loadCustomers(agent_id, preserveView = true) {
      // Save current scroll position
      const scrollPos = window.scrollY;

      const loading = document.getElementById("loadingOverlay");
      // Only show loading if not preserving view (e.g. first load)
      if (!preserveView) loading.classList.add("active");

      console.log("🔄 جاري تحميل بيانات العملاء للمندوب:", agent_id);

      // Debug: Comparison & Content Check
      const { count: totalCount } = await supabase.from("customers").select("*", { count: 'exact', head: true });
      const { data: anyCustomer } = await supabase.from('customers').select('agent_id, name').limit(1).maybeSingle();
      const { count: nullAgentCount } = await supabase.from("customers").select("*", { count: 'exact', head: true }).is('agent_id', null);
      const { data: allAgents } = await supabase.from('agents').select('id, name');

      console.log("🔍 --- فحص قاعدة البيانات ---");
      console.log("📊 إجمالي العملاء في الجدول:", totalCount);
      console.log("📊 عملاء بدون مندوب (NULL):", nullAgentCount);
      console.log("📊 قائمة المناديب المتاحين:", allAgents);
      console.log("🔍 عينة لمندوب من جدول العملاء:", anyCustomer?.agent_id, "اسم العينة:", anyCustomer?.name);
      console.log("🔍 ID المندوب الحالي:", agent_id);
      console.log("🔍 هل هناك تطابق؟", anyCustomer?.agent_id === agent_id);
      console.log("🔍 ---------------------------");

      const { data: customers, error } = await supabase
        .from("customers")
        .select("*")
        .eq("agent_id", agent_id)
        .order("section", { ascending: true });

      if (error) {
        console.error("❌ خطأ تحميل العملاء:", error);
        alert("⚠️ حدث خطأ أثناء تحميل العملاء: " + error.message);
        return;
      }

      console.log("📥 نتيجة الاستعلام من سوبابيز:", customers);

      // Get collections for correct amounts
      const { data: collections } = await supabase
        .from('collections')
        .select('*')
        .eq('collected_by', agent_id);

      // Create a map of customer_id to collection amount
      collectionAmounts = {};
      collections?.forEach(collection => {
        if (collection.customer_id) {
          // also consider due_amount if collection record stored it
          const amount = collection.amount || collection.original_amount || collection.debt_amount || collection.due_amount || 0;
          collectionAmounts[collection.customer_id] = parseFloat(amount) || 0;
        }
      });

      // Process customers with collection amounts (aligned with Admin Dashboard logic)
      const processedData = customers.map(customer => {
        return {
          ...customer,
          display_amount: calculateAmount(customer, collectionAmounts)
        };
      });

      const data = processedData;

      loading.classList.remove("active");

      console.log("✅ تم تحميل بيانات العملاء:", data);
      console.log("📊 عدد العملاء:", data?.length || 0);

      if (!data || data.length === 0) {
        console.log("⚠️ لا توجد بيانات عملاء لهذا المندوب");
        const customersTable = document.getElementById('customersTable');
        if (customersTable) {
          customersTable.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">لا توجد بيانات عملاء حالياً</td></tr>';
        }
        // إظهار رسالة في الأقسام
        const sectionsGridMain = document.getElementById('sectionsGridMain');
        if (sectionsGridMain) {
          sectionsGridMain.innerHTML = `
            <div style="text-align: center; padding: 60px; color: white;">
              <i class="fas fa-users-slash" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
              <div style="font-size: 20px; margin-bottom: 20px;">لا توجد بيانات عملاء مرتبطة بك حالياً</div>
              <button onclick="reassignAllCustomers()" class="btn" style="background: var(--accent-color); color: white; padding: 12px 24px; border-radius: 10px; font-weight: bold; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <i class="fas fa-magic"></i> نقل جميع العملاء في النظام إليّ (للاختبار)
              </button>
            </div>`;
        }
        return;
      }

      customersData = data || [];

      // تحميل الأقسام وفئات الباقات في الفلاتر
      loadSections();
      loadPackageCategories();

      // عرض البيانات
      if (preserveView) {
        // الحفاظ على الفلتر الحالي إن وجد
        applyFilters(false);
      } else {
        // العرض الافتراضي (كل البيانات)
        filteredData = [...customersData];
        displaySections(filteredData);
        updateStatistics(filteredData, collectionAmounts);
      }

      // تحديث حالة فترة التحصيل
      await window.updateCollectionPeriodStatus();

      // تحديث العملاء المحصلين
      displayCollectedCustomers(customersData);

      // Restore scroll position after a short delay to allow DOM rendering
      if (preserveView && scrollPos > 0) {
        setTimeout(() => window.scrollTo(0, scrollPos), 100);
      }
    }

    // ⚡️ عرض الأقسام
    function displaySections(data) {
      const sectionsGridMain = document.getElementById('sectionsGridMain');
      if (!sectionsGridMain) return;

      if (!data || data.length === 0) {
        sectionsGridMain.innerHTML = '<div style="text-align: center; padding: 60px; color: white;"><i class="fas fa-search" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i><div style="font-size: 20px;">لا توجد بيانات عملاء تطابق هذا البحث أو الفلتر</div></div>';
        return;
      }

      // تجميع العملاء حسب الأقسام
      const sections = {};
      data.forEach(customer => {
        const section = customer.section || 'غير محدد';
        if (!sections[section]) {
          sections[section] = {
            customers: []
          };
        }
        sections[section].customers.push(customer);
      });

      let html = '';
      Object.entries(sections).forEach(([sectionName, sectionData]) => {
        const pendingCustomers = sectionData.customers.filter(c => c.collection_status !== "تم التحصيل" && c.collection_status !== "تم الإيقاف");

        html += `
              <div class="section-group" style="margin-bottom: 40px;">
                <div class="section-header-main" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 24px; font-weight: bold;">${sectionName}</h3>
                    <div style="display: flex; gap: 10px;">
                      <button onclick="selectAllSectionCustomers('${sectionName}')" class="btn btn-sm" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px;">
                        <i class="fas fa-check-square"></i> تحديد الكل
                      </button>
                      <button onclick="collectSectionCustomers('${sectionName}')" class="btn btn-sm" style="background: rgba(40, 167, 69, 0.8); border: 1px solid rgba(40, 167, 69, 0.9); color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px;">
                        <i class="fas fa-coins"></i> تحصيل القسم
                      </button>
                    </div>
                  </div>
                  <div style="display: flex; gap: 15px; align-items: center;">
                    <span style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-weight: bold;">
                      ${sectionData.customers.length} إجمالي
                    </span>
                    <span style="background: rgba(40, 167, 69, 0.3); padding: 8px 16px; border-radius: 20px; font-weight: bold;">
                      ${sectionData.customers.filter(c => c.collection_status === "تم التحصيل").length} محصل
                    </span>
                    <span style="background: rgba(220, 53, 69, 0.3); padding: 8px 16px; border-radius: 20px; font-weight: bold;">
                      ${pendingCustomers.length} متبقي
                    </span>
                  </div>
                </div>
                
                <div class="customers-cards-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; padding: 0 10px; max-width: 1400px; margin: 0 auto;">
            `;

        // تجميع الشرائح المتعددة لنفس العميل
        const groupedCustomers = {};
        pendingCustomers.forEach(customer => {
          const name = (customer.name || customer.customer_name || 'غير معروف').trim().toLowerCase();
          if (!groupedCustomers[name]) {
            groupedCustomers[name] = {
              originalName: customer.name || customer.customer_name || 'غير معروف',
              customers: [],
              totalAmount: 0,
              allPhones: new Set(),
              allAddresses: new Set(),
              allNotes: new Set(),
              allPackages: new Set(),
              allSections: new Set(),
              ids: []
            };
          }
          groupedCustomers[name].customers.push(customer);
          groupedCustomers[name].ids.push(customer.id);
          groupedCustomers[name].totalAmount += calculateAmount(customer);

          const phone = customer.phone || customer.customer_phone || 'غير محدد';
          if (phone && phone !== 'غير محدد') {
            groupedCustomers[name].allPhones.add(phone);
          }

          const address = customer.address || customer.customer_address || 'غير محدد';
          if (address && address !== 'غير محدد') {
            groupedCustomers[name].allAddresses.add(address);
          }

          const notes = customer.notes || customer.customer_notes || 'لا توجد ملاحظات';
          if (notes && notes !== 'لا توجد ملاحظات') {
            groupedCustomers[name].allNotes.add(notes);
          }

          // إضافة الباقة/الشريحة
          const servicePackage = customer.package || customer.package_name || customer.service_type || 'شريحة أساسية';
          groupedCustomers[name].allPackages.add(servicePackage);

          // إضافة القسم
          const section = customer.section || 'غير محدد';
          if (section && section !== 'غير محدد') {
            groupedCustomers[name].allSections.add(section);
          }
        });

        // عرض كل مجموعة عملاء في كرت واحد
        Object.values(groupedCustomers).forEach(group => {
          const phonesArray = Array.from(group.allPhones);
          const addressesArray = Array.from(group.allAddresses);
          const notesArray = Array.from(group.allNotes);
          const packagesArray = Array.from(group.allPackages);
          const sectionsArray = Array.from(group.allSections);

          html += `
                <div class="customer-card grouped-card" style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; transition: all 0.3s ease; border: 3px solid transparent; hover: transform translateY(-3px); hover: box-shadow 0 8px 25px rgba(0,0,0,0.15); min-height: 500px; display: flex; flex-direction: column;">
                  <div style="position: absolute; top: -10px; right: -10px; background: linear-gradient(45deg, #007bff, #0056b3); color: white; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; box-shadow: 0 2px 8px rgba(0, 123, 255, 0.4); z-index: 10;">
                    ${group.customers.length} شرائح
                  </div>
                  
                  <input type="checkbox" class="customer-checkbox" value="${group.ids.join(',')}" onchange="updateSelectedCount()" 
                        style="position: absolute; top: 15px; left: 15px; width: 20px; height: 20px; cursor: pointer; z-index: 10;">
                  
                  <div class="customer-header" style="text-align: center; margin-bottom: 15px; padding-right: 40px;">
                    <h4 style="margin: 0; color: var(--primary-color); font-size: 18px; font-weight: bold; word-break: break-word; line-height: 1.3; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${group.originalName}</h4>
                    <div style="margin-top: 8px; padding: 6px 12px; background: rgba(0, 123, 255, 0.1); border-radius: 15px; display: inline-block;">
                      <span style="color: #007bff; font-size: 12px; font-weight: bold;">عميل متعدد الشرائح</span>
                    </div>
                  </div>
                  
                  <div class="customer-details" style="margin-bottom: 15px; flex-grow: 1;">
                    <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 12px; border-radius: 10px; margin-bottom: 12px;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="color: #6c757d; font-size: 13px; font-weight: 600;">إجمالي المبلغ:</span>
                        <span style="color: var(--accent-color); font-size: 18px; font-weight: bold; background: white; padding: 4px 8px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${group.totalAmount.toFixed(2)} ج.م</span>
                      </div>
                    </div>
                    
                    ${packagesArray.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                      <div style="color: #6c757d; font-size: 13px; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-box" style="color: #6f42c1;"></i>
                        الشرائح (${packagesArray.length}):
                      </div>
                      <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${packagesArray.map(pkg => `
                          <div style="background: linear-gradient(135deg, #e3e3e3, #d1d1d1); padding: 6px 10px; border-radius: 15px; border-right: 3px solid #6f42c1;">
                            <span style="color: #333; font-size: 11px; font-weight: 600;">${pkg}</span>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                    ` : ''}
                    
                    ${sectionsArray.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                      <div style="color: #6c757d; font-size: 13px; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-building" style="color: #20c997;"></i>
                        الأقسام (${sectionsArray.length}):
                      </div>
                      <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${sectionsArray.map(section => `
                          <div style="background: linear-gradient(135deg, #d1ecf1, #bee5eb); padding: 6px 10px; border-radius: 15px; border-right: 3px solid #20c997;">
                            <span style="color: #0c5460; font-size: 11px; font-weight: 600;">${section}</span>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 12px;">
                      <div style="color: #6c757d; font-size: 13px; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-phone" style="color: var(--info-color);"></i>
                        أرقام الهواتف (${phonesArray.length}):
                      </div>
                      <div style="display: flex; flex-direction: column; gap: 6px;">
                        ${phonesArray.map(phone => {
            // Clean up phone number: remove all non-digits
            let cleanedPhone = phone.replace(/\D/g, '');

            // For Egyptian numbers starting with +1, keep them as is
            if (cleanedPhone.startsWith('1')) {
              // Egyptian number with +1 format, keep as is
              cleanedPhone = cleanedPhone;
            }
            // If number starts with 0, replace it with 20 for Egypt
            else if (cleanedPhone.startsWith('0')) {
              cleanedPhone = '20' + cleanedPhone.substring(1);
            }
            // If number doesn't start with 20, prepend 20
            else if (!cleanedPhone.startsWith('20')) {
              cleanedPhone = '20' + cleanedPhone;
            }

            return `
                            <div style="display: flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 8px 12px; border-radius: 8px; border-right: 3px solid var(--info-color); cursor: pointer;" onclick="window.open('https://api.whatsapp.com/send/?phone=${cleanedPhone}&text&type=phone_number&app_absent=0', '_blank')">
                              <span style="color: #333; font-size: 13px; font-weight: 500;">${phone}</span>
                              <span style="color: #25d366; font-size: 11px; font-weight: 600; margin-left: auto;">📱 إرسال</span>
                            </div>
                          `;
          }).join('')}
                      </div>
                    </div>
                    
                    ${addressesArray.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                      <div style="color: #6c757d; font-size: 13px; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-map-marker-alt" style="color: var(--danger-color);"></i>
                        العناوين (${addressesArray.length}):
                      </div>
                      <div style="display: flex; flex-direction: column; gap: 6px;">
                        ${addressesArray.map(address => `
                          <div style="background: #f8f9fa; padding: 8px 12px; border-radius: 8px; border-right: 3px solid var(--danger-color);">
                            <span style="color: #333; font-size: 12px; font-weight: 500; line-height: 1.4;">${address}</span>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                    ` : ''}
                    
                    ${notesArray.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                      <div style="color: #6c757d; font-size: 13px; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-sticky-note" style="color: var(--warning-color);"></i>
                        الملاحظات (${notesArray.length}):
                      </div>
                      <div style="display: flex; flex-direction: column; gap: 6px;">
                        ${notesArray.map(note => `
                          <div style="background: #fff3cd; padding: 8px 12px; border-radius: 8px; border-right: 3px solid var(--warning-color);">
                            <span style="color: #856404; font-size: 12px; font-weight: 500; line-height: 1.4;">${note}</span>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 15px;">
                      <label style="color: #6c757d; font-size: 13px; margin-bottom: 6px; display: block; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-edit" style="color: var(--primary-color);"></i>
                        ملاحظات التحصيل:
                      </label>
                      <textarea 
                        id="collectNotes_${group.ids[0]}" 
                        placeholder="أدخل ملاحظات التحصيل للشرائح المجمعة..."
                        style="width: 100%; min-height: 60px; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 13px; resize: vertical; font-family: inherit; transition: all 0.3s ease; box-sizing: border-box; background: #f8f9fa;"
                        onfocus="this.style.borderColor='var(--primary-color)'; this.style.background='white';"
                        onblur="this.style.borderColor='#e9ecef'; this.style.background='#f8f9fa';"
                      ></textarea>
                    </div>
                    
                    <div style="margin-bottom: 15px; background: #fff3cd; padding: 10px; border-radius: 8px; border: 1px solid #ffeeba;">
                      <label style="font-size: 13px; color: #856404; font-weight: bold; margin-bottom: 5px; display: block;">المبلغ المحصل (سداد كامل أو جزئي):</label>
                      <input type="number" id="collectAmountGroup_${group.ids[0]}" value="${group.totalAmount.toFixed(2)}" step="0.5" 
                        style="width: 100%; padding: 10px; border: 2px solid #ffc107; border-radius: 8px; font-size: 16px; font-weight: bold; color: #212529;">
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 8px 12px; border-radius: 8px; border: 1px solid #dee2e6;">
                      <span style="color: #495057; font-size: 13px; font-weight: 600;">الحالة:</span>
                      ${group.customers.every(c => c.collection_status === 'لم يتم التحصيل')
              ? '<span class="status-badge pending" style="background: #ffc107; color: #856404; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold;">لم يتم التحصيل</span>'
              : '<span class="status-badge partial" style="background: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold;">تحصيل جزئي / متبقي</span>'
            }
                    </div>
                  </div>
                  
                  <div class="customer-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: auto;">
                    <button class="btn btn-success" onclick="const amt = document.getElementById('collectAmountGroup_${group.ids[0]}').value; collectGroupedCustomers('${group.ids.join(',')}', '${group.originalName}', amt)" style="padding: 12px 8px; font-size: 13px; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 6px; font-weight: 600; background: linear-gradient(45deg, var(--success-color), #2ecc71); box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);">
                      <i class="fas fa-check-circle"></i>
                      <span>تحصيل المبلغ</span>
                    </button>
                    <button class="btn btn-primary" onclick="viewGroupedCustomerDetails('${group.ids.join(',')}', '${group.originalName}')" style="padding: 12px 8px; font-size: 13px; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 6px; font-weight: 600; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); box-shadow: 0 3px 10px rgba(44, 62, 80, 0.3);">
                      <i class="fas fa-eye"></i>
                      <span>تفاصيل الكل</span>
                    </button>
                  </div>
                  
                  <div class="customer-secondary-actions" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-top: 8px;">
                    <button class="btn btn-info btn-sm" onclick="saveGroupedCustomerNote('${group.ids.join(',')}', '${group.originalName}')" style="padding: 8px 6px; font-size: 11px; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 4px;">
                      <i class="fas fa-save"></i>
                      <span>حفظ</span>
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="stopGroupedCustomerService('${group.ids.join(',')}', '${group.originalName}')" style="padding: 8px 6px; font-size: 11px; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 4px;">
                      <i class="fas fa-stop-circle"></i>
                      <span>وقف الكل</span>
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="expandGroupedCustomers('${group.ids.join(',')}')" style="padding: 8px 6px; font-size: 11px; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 4px;">
                      <i class="fas fa-expand-alt"></i>
                      <span>توسيع</span>
                    </button>
                  </div>
                </div>
              `;
        });

        html += `
                </div>
              </div>
            `;
      });

      sectionsGridMain.innerHTML = html;
    }

    // ⚡️ تحصيل جميع عملاء قسم معين
    window.collectSectionCustomers = async function (sectionName) {
      console.log(`🔄 بدء تحصيل قسم: ${sectionName}`);

      const sectionCustomers = customersData.filter(c => (c.section || 'غير محدد') === sectionName && c.collection_status !== "تم التحصيل");

      console.log(`📊 العملاء المتبقيين في قسم ${sectionName}:`, sectionCustomers.length);

      if (sectionCustomers.length === 0) {
        alert('⚠️ لا يوجد عملاء متبقيين في هذا القسم');
        return;
      }

      // حساب إجمالي المبلغ مسبقاً
      let totalAmount = 0;
      sectionCustomers.forEach(customer => {
        const amountValue = parseFloat(customer.display_amount || 0) || 0;
        totalAmount += amountValue;
      });

      if (!confirm(`⚠️ هل أنت متأكد من تحصيل جميع عملاء قسم "${sectionName}" (${sectionCustomers.length} عميل) بإجمالي ${totalAmount} ج.م؟`)) return;

      const agent_id = localStorage.getItem("agent_id");
      if (!agent_id) {
        alert('⚠️ لا يمكن تحديد المندوب');
        return;
      }

      const loading = document.getElementById("loadingOverlay");
      loading.classList.add("active");

      try {
        const periodLabel = new Date().toISOString().slice(0, 7);

        sectionCustomers.forEach(customer => {
          // الحصول على ملاحظات التحصيل من الـ textarea
          const collectNotes = document.getElementById(`collectNotes_${customer.id}`)?.value || '';
          console.log(`📝 ملاحظات العميل ${customer.name}:`, collectNotes);

          // حساب المبلغ بشكل صحيح - استخدام المبلغ المستحق الفعلي
          const amountValue = parseFloat(customer.display_amount || 0) || 0;
          totalAmountFinal += amountValue; // جمع المبالغ

          collections.push({
            customer_id: customer.id,
            collected_by: agent_id,
            amount: amountValue, // استخدام المبلغ المستحق الفعلي
            package_price: parseFloat(customer.package_price || 0),
            period_label: periodLabel,
            notes: collectNotes || null
          });

          // تجميع الملاحظات للجدول المنفصل (agent_notes) للبحث والرجوع
          if (collectNotes.trim()) {
            notesToSave.push({
              agent_id: agent_id,
              customer_name: customer.name || customer.customer_name || 'غير معروف',
              customer_phone: customer.phone || customer.customer_phone || '',
              note_text: `ملاحظات التحصيل الجماعي: ${collectNotes}`
            });
          }
        });

        console.log(`💰 إجمالي المبلغ المحصل من قسم ${sectionName}: ${totalAmountFinal} ج.م`);
        console.log(`📝 عدد الملاحظات المحفوظة: ${notesToSave.length}`);
        console.log(`📊 عدد التحصيلات التي سيتم إدخالها: ${collections.length}`);

        // إدخال التحصيلات
        const { error } = await supabase
          .from("collections")
          .insert(collections);

        if (error) {
          console.error("❌ خطأ في تحصيل القسم:", error);
          throw error;
        }

        console.log("✅ تم إدخال التحصيلات بنجاح");

        // حفظ الملاحظات في جدول agent_notes إذا وجدت
        if (notesToSave.length > 0) {
          const { error: notesError } = await supabase
            .from("agent_notes")
            .upsert(notesToSave, {
              onConflict: 'agent_id,customer_phone'
            });

          if (notesError) {
            console.warn("⚠️ تحذير: لم يتم حفظ بعض الملاحظات:", notesError);
          } else {
            console.log("✅ تم حفظ الملاحظات بنجاح");
          }
        }

        // تحديث حالة العملاء
        const customerIds = sectionCustomers.map(c => c.id);
        const { error: updateError } = await supabase
          .from("customers")
          .update({
            collection_status: "تم التحصيل",
            debt_amount: 0,
            due_amount: 0
          })
          .in("id", customerIds);

        if (updateError) {
          console.error("❌ خطأ في تحديث حالة العملاء:", updateError);
          throw updateError;
        }

        console.log("✅ تم تحديث حالة العملاء بنجاح");

        alert(`✅ تم تحصيل ${collections.length} عميل من قسم "${sectionName}" بنجاح\n💰 إجمالي المبلغ: ${totalAmountFinal} ج.م\n📝 تم حفظ ${notesToSave.length} ملاحظة`);

        // إعادة تحميل البيانات
        await loadCustomers(agent_id, true);

      } catch (error) {
        console.error("❌ خطأ في تحصيل القسم:", error);
        alert("⚠️ حدث خطأ أثناء تحصيل القسم: " + (error.message || "خطأ غير معروف"));
      } finally {
        loading.classList.remove("active");
      }
    };

    // ⚡️ تحديد جميع عملاء قسم معين
    window.selectAllSectionCustomers = function (sectionName) {
      const sectionCustomers = customersData.filter(c => (c.section || 'غير محدد') === sectionName);

      // إلغاء تحديد الكل أولاً
      document.querySelectorAll('.customer-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });

      // تحديد عملاء القسم
      sectionCustomers.forEach(customer => {
        const checkbox = document.querySelector(`.customer-checkbox[value="${customer.id}"]`);
        if (checkbox) {
          checkbox.checked = true;
        }
      });

      updateSelectedCount();
      alert(`✅ تم تحديد ${sectionCustomers.length} عميل من قسم "${sectionName}"`);
    };

    // ⚡️ حفظ ملاحظات العميل في localStorage
    window.saveCustomerNoteToStorage = function (customerId, customerName, notes) {
      if (!notes || notes.trim() === '') return;

      // حفظ الملاحظات في localStorage
      const savedNotes = JSON.parse(localStorage.getItem('customerNotes') || '{}');
      savedNotes[customerId] = {
        name: customerName,
        notes: notes.trim(),
        savedAt: new Date().toISOString()
      };
      localStorage.setItem('customerNotes', JSON.stringify(savedNotes));
      console.log(`💾 تم حفظ ملاحظات العميل ${customerName}:`, notes);
    };

    // ⚡️ استرجاع ملاحظات العميل من localStorage
    window.getCustomerNoteFromStorage = function (customerId) {
      const savedNotes = JSON.parse(localStorage.getItem('customerNotes') || '{}');
      return savedNotes[customerId]?.notes || '';
    };

    // ⚡️ حفظ ملاحظة العميل
    window.saveCustomerNote = async (customerId, customerName) => {
      const notesTextarea = document.getElementById(`collectNotes_${customerId}`);
      if (!notesTextarea) {
        alert('⚠️ لا يمكن العثور على خانة الملاحظات');
        return;
      }

      const notes = notesTextarea.value.trim();
      if (!notes) {
        alert("⚠️ يرجى إدخال ملاحظات أولاً");
        return;
      }

      // حفظ الملاحظات في localStorage
      saveCustomerNoteToStorage(customerId, customerName, notes);

      const loading = document.getElementById("loadingOverlay");
      loading.classList.add("active");

      try {
        const { error } = await supabaseClient
          .from("customers")
          .update({ notes: notes })
          .eq("id", customerId);

        if (error) {
          console.error("❌ خطأ في حفظ الملاحظة:", error);
          throw error;
        }

        alert(`✅ تم حفظ ملاحظات العميل ${customerName} بنجاح`);
        notesTextarea.value = ''; // مسح الخانة بعد الحفظ

        // إعادة تحميل البيانات مع الحفاظ على العرض الحالي
        await loadCustomers(localStorage.getItem("agent_id"), true);

      } catch (error) {
        console.error("❌ خطأ في حفظ الملاحظة:", error);
        alert("⚠️ حدث خطأ أثناء حفظ الملاحظة: " + (error.message || "خطأ غير معروف"));
      } finally {
        loading.classList.remove("active");
      }
    };

    // ⚡️ وقف خدمة العميل
    window.stopCustomerService = async (customerId, customerName) => {
      if (!confirm(`⚠️ هل أنت متأكد من وقف خدمة العميل ${customerName}؟`)) return;

      const agent_id = localStorage.getItem("agent_id");
      if (!agent_id) {
        alert('⚠️ لا يمكن تحديد المندوب');
        return;
      }

      const loading = document.getElementById("loadingOverlay");
      loading.classList.add("active");

      try {
        const customer = customersData.find(c => c.id === customerId);
        const customerPhone = customer?.phone || customer?.customer_phone || '';

        const { error } = await supabase
          .from("stop_requests")
          .insert({
            agent_id: agent_id,
            customer_id: customerId,
            customer_name: customerName,
            customer_phone: customerPhone,
            reason: "طلب وقف الخدمة"
          });

        if (error) {
          console.error("❌ خطأ في طلب وقف الخدمة:", error);
          throw error;
        }

        alert(`✅ تم إرسال طلب وقف خدمة العميل ${customerName} بنجاح`);

        // إعادة تحميل البيانات
        await loadCustomers(agent_id, true);

      } catch (error) {
        console.error("❌ خطأ في طلب وقف الخدمة:", error);
        alert("⚠️ حدث خطأ أثناء طلب وقف الخدمة: " + (error.message || "خطأ غير معروف"));
      } finally {
        loading.classList.remove("active");
      }
    };

    // ⚡️ عرض عملاء قسم معين
    window.showSectionCustomers = function (sectionName) {
      const sectionCustomers = customersData.filter(c => (c.section || 'غير محدد') === sectionName);

      const modalOverlay = document.getElementById('modalOverlay');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      // Check if modal elements exist
      if (!modalOverlay || !modalTitle || !modalBody) {
        console.error('Modal elements not found in showSectionCustomers, creating modal...');
        createModalIfNotExists();

        // Retry after creating modal
        setTimeout(() => showSectionCustomers(sectionName), 200);
        return;
      }

      modalTitle.textContent = `عملاء قسم: ${sectionName}`;

      let html = `
            <div style="padding: 20px;">
              <div style="background: var(--light-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: var(--primary-color);">إجمالي العملاء: ${sectionCustomers.length}</h4>
              </div>
              <div style="overflow-x: auto;">
                <table class="modern-table">
                  <thead>
                    <tr>
                      <th>اسم العميل</th>
                      <th>الموبايل</th>
                      <th>المبلغ</th>
                      <th>الحالة</th>
                      <th>إجراءات</th>
                    </tr>
                  </thead>
                  <tbody>
          `;

      sectionCustomers.forEach(customer => {
        const amount = customer.display_amount ||
          (parseFloat(customer.package_price || 0) + parseFloat(customer.debt_amount || 0) + parseFloat(customer.due_amount || 0)) || 0;
        const status = customer.collection_status === "تم التحصيل" ?
          '<span class="status-badge collected">تم التحصيل</span>' :
          '<span class="status-badge pending">لم يتم التحصيل</span>';

        html += `
              <tr>
                <td>${customer.name || customer.customer_name || 'غير معروف'}</td>
                <td>${customer.phone || customer.customer_phone || 'غير محدد'}</td>
                <td style="font-weight: bold;">${amount} ج.م</td>
                <td>${status}</td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="viewCustomerDetails('${customer.id}')">
                    <i class="fas fa-eye"></i>
                  </button>
                </td>
              </tr>
            `;
      });

      html += `
                  </tbody>
                </table>
              </div>
              <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="closeModal()">إغلاق</button>
              </div>
            </div>
          `;

      modalBody.innerHTML = html;
      modalOverlay.classList.add('active');
    };

    // ⚡️ عرض العملاء المحصلين
    function displayCollectedCustomers(data) {
      console.log("🔄 displayCollectedCustomers تم استدعاؤها، البيانات:", data);

      // لم نعد نستخدم هذه الدالة في الصفحة الرئيسية
      // البيانات ستتم معالجتها في تبويب الشريط الجانبي
      console.log("📊 تم تخزين بيانات العملاء المحصلين للتبويب الجانبي");

      const collected = data.filter(c => c.collection_status === "تم التحصيل");
      console.log("📊 العملاء المحصلين:", collected.length, "من إجمالي", data.length);
    }

    // ⚡️ تحصيل العميل (محسن للأداء)
    async function collect(id, name, amount) {
      if (!confirm(`⚠️ هل أنت متأكد من تحصيل العميل ${name} بمبلغ ${amount} ج.م؟`)) return;

      const agent_id = localStorage.getItem("agent_id");
      if (!agent_id) {
        alert('⚠️ لا يمكن تحديد المندوب');
        return;
      }

      // الحصول على ملاحظات التحصيل
      const collectNotes = document.getElementById(`collectNotes_${id}`)?.value || '';

      const loading = document.getElementById("loadingOverlay");
      loading.classList.add("active");

      try {
        console.log(`🔄 بدء تحصيل العميل: ${id} - المبلغ: ${amount} - ملاحظات: ${collectNotes}`);

        // جلب بيانات العميل الحالية لحساب المتبقي
        const customerObj = customersData.find(c => String(c.id) === String(id));
        const totalDue = customerObj ? (parseFloat(customerObj.package_price || 0) + parseFloat(customerObj.debt_amount || 0) + parseFloat(customerObj.due_amount || 0)) : parseFloat(amount);
        const amountPaid = parseFloat(amount) || 0;
        const remainingDebt = Math.max(0, totalDue - amountPaid);

        const status = remainingDebt > 0 ? "تحصيل جزئي" : "تم التحصيل";

        // تحديث حالة العميل والمتبقي
        const { error: updateError } = await supabase
          .from("customers")
          .update({
            collection_status: status,
            debt_amount: remainingDebt,
            due_amount: 0
          })
          .eq("id", id);

        if (updateError) {
          console.error("❌ خطأ في تحديث العميل:", updateError);
          throw updateError;
        }

        // إضافة سجل التحصيل مع التاريخ - استخدام collected_by الصحيح
        const amountValue = parseFloat(amount) || 0; // التأكد من أن المبلغ رقم وليس null
        const periodLabel = new Date().toISOString().slice(0, 7);

        const { error: insertError } = await supabase
          .from("collections")
          .insert([{
            collected_by: agent_id,
            customer_id: id,
            amount: amountValue,
            package_price: parseFloat(customerObj?.package_price || 0),
            period_label: periodLabel,
            notes: collectNotes || null
          }]);

        if (insertError) {
          console.error("❌ خطأ في إدخال التحصيل:", insertError);
          throw insertError;
        }

        // حفظ الملاحظات في جدول agent_notes إذا وجدت
        if (collectNotes.trim()) {
          const customer = customersData.find(c => c.id === id);
          const customerPhone = customer?.phone || customer?.customer_phone || '';

          const { error: notesError } = await supabase
            .from("agent_notes")
            .upsert({
              agent_id: agent_id,
              customer_name: name,
              customer_phone: customerPhone,
              note_text: `ملاحظات التحصيل: ${collectNotes}`
            }, {
              onConflict: 'agent_id,customer_phone'
            });

          if (notesError) {
            console.warn("⚠️ تحذير: لم يتم حفظ الملاحظات:", notesError);
          }
        }

        console.log("✅ تم التحصيل بنجاح");

        // تحديث واجهة المستخدم فوراً
        const card = document.querySelector(`[onclick*="collect('${id}'"]`)?.closest('.customer-card');
        if (card) {
          card.style.opacity = '0.6';
          card.style.pointerEvents = 'none';
          const statusBadge = card.querySelector('.status-badge');
          if (statusBadge) {
            statusBadge.textContent = 'تم التحصيل';
            statusBadge.style.background = '#28a745';
            statusBadge.style.color = 'white';
          }
        }

        alert(`✅ تم تحصيل العميل ${name} بنجاح`);

        // إعادة تحميل البيانات مع الحفاظ على الوضع الحالي
        await loadCustomers(agent_id, true);

      } catch (error) {
        console.error("❌ خطأ في التحصيل:", error);
        alert("⚠️ حدث خطأ أثناء التحصيل: " + (error.message || "خطأ غير معروف"));
      } finally {
        loading.classList.remove("active");
      }
    };

    // ✅ حفظ الملاحظة
    async function saveNote(id, name, phone) {
      const agent_id = localStorage.getItem("agent_id");
      const note = document.getElementById(`note_${id}`).value.trim();
      if (!note) return alert("⚠️ اكتب ملاحظة أولًا");

      await supabase.from("agent_notes").upsert(
        [
          {
            agent_id,
            customer_name: name,
            customer_phone: phone,
            note_text: note,
          },
        ],
        { onConflict: ["agent_id", "customer_phone"] }
      );

      alert("✅ تم حفظ الملاحظة");
    };



    // ✅ جلب رابط واتساب
    function getWhatsAppLink(phone) {
      let p = phone.replace(/\D/g, "");
      if (p.length === 10) p = "0" + p;
      if (p.startsWith("0")) p = "20" + p.slice(1);
      else if (!p.startsWith("20")) p = "20" + p;
      return `https://wa.me/${p}`;
    }

    // ✅ دوال التحصيل الجماعي
    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('.customer-checkbox:checked');
      const count = checkboxes.length;

      console.log(`🔄 تحديث عدد المحددين: ${count}`);

      // تحديث العداد في الأكورديون (إذا كان موجود)
      const selectedCountElement = document.getElementById('selectedCount');
      if (selectedCountElement) {
        selectedCountElement.textContent = `${count} عميل محدد`;
      }

      // تحديث العداد في الزر العائم (إذا كان موجود)
      const floatingCountElement = document.getElementById('floatingSelectedCount');
      if (floatingCountElement) {
        floatingCountElement.textContent = count;
      }

      // إظهار أو إخفاء الزر العائم (إذا كان موجود)
      const floatingBtn = document.getElementById('floatingBulkCollect');
      if (floatingBtn) {
        floatingBtn.style.display = count > 0 ? 'flex' : 'none';
        console.log(`🔄 الزر العائم: ${count > 0 ? 'ظاهر' : 'مخفي'}`);
      }

      // إظهار أو إخفاء أزرار التحصيل السريع
      checkboxes.forEach(checkbox => {
        const card = checkbox.closest('.customer-card');
        const quickActions = card ? card.querySelector('.quick-actions') : null;

        if (checkbox.checked) {
          if (card) card.classList.add('selected');
          if (quickActions) {
            quickActions.style.display = 'block';
          }
        } else {
          if (card) card.classList.remove('selected');
          if (quickActions) {
            quickActions.style.display = 'none';
          }
        }
      });

      // إخفاء أزرار التحصيل السريع للبطاقات غير المحددة
      document.querySelectorAll('.customer-card').forEach(card => {
        const checkbox = card.querySelector('.customer-checkbox');
        if (!checkbox.checked) {
          card.classList.remove('selected');
          const quickActions = card.querySelector('.quick-actions');
          if (quickActions) {
            quickActions.style.display = 'none';
          }
        }
      });
    }
    window.updateSelectedCount = updateSelectedCount;

    function selectAllCustomers() {
      const checkboxes = document.querySelectorAll('.customer-checkbox');
      checkboxes.forEach(checkbox => checkbox.checked = true);
      updateSelectedCount();
    }
    window.selectAllCustomers = selectAllCustomers;

    function deselectAllCustomers() {
      const checkboxes = document.querySelectorAll('.customer-checkbox');
      checkboxes.forEach(checkbox => checkbox.checked = false);
      updateSelectedCount();
    }
    window.deselectAllCustomers = deselectAllCustomers;

    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      const checkboxes = document.querySelectorAll('.customer-checkbox');
      checkboxes.forEach(checkbox => checkbox.checked = selectAllCheckbox.checked);
      updateSelectedCount();
    }
    window.toggleSelectAll = toggleSelectAll;

    // ✅ وقف الخدمة
    async function requestStopService(id, name, phone) {
      const agent_id = localStorage.getItem("agent_id");
      if (!agent_id || !confirm(`❗ هل تريد وقف الخدمة للعميل ${name}?`))
        return;

      const { data: existing } = await supabase
        .from("stop_requests")
        .select("id")
        .eq("agent_id", agent_id)
        .eq("customer_id", id);

      if (existing.length > 0)
        return alert("⚠️ تم تقديم طلب بالفعل لهذا العميل");

      await supabase.from("stop_requests").insert([
        {
          agent_id,
          customer_id: id,
          customer_name: name,
          customer_phone: phone,
        },
      ]);
      alert(`✅ تم وقف الخدمة عن ${name}`);

      const row = document.getElementById(`row_${id}`);
      if (row) row.style.backgroundColor = "#ffaaaa";

      await loadStoppedCustomers(agent_id);
    };

    // ✅ إلغاء الوقف
    async function cancelStopRequest(stop_id, name) {
      if (!confirm(`هل تريد إلغاء وقف الخدمة عن ${name}?`)) return;

      await supabase.from("stop_requests").delete().eq("id", stop_id);
      alert(`✅ تم إلغاء الوقف عن ${name}`);

      const agent_id = localStorage.getItem("agent_id");
      await loadStoppedCustomers(agent_id);
      await loadCustomers(agent_id, true);
    };

    // ✅ تحميل العملاء الموقوفين
    async function loadStoppedCustomers(agent_id) {
      console.log("🚫 جاري تحميل طلبات الوقف للمندوب:", agent_id);

      // لم نعد نستخدم هذه الدالة في الصفحة الرئيسية
      // البيانات ستتم معالجتها في تبويب الشريط الجانبي
      try {
        const { data, error } = await supabase
          .from("stop_requests")
          .select("*")
          .eq("agent_id", agent_id)
          .order("created_at", { ascending: false });

        if (error) {
          console.error("❌ خطأ في تحميل طلبات الوقف:", error);
          return;
        }

        console.log("📊 عدد طلبات الوقف تم تحميلها للتبويب الجانبي:", data?.length || 0);

        // تخزين البيانات للاستخدام في تبويب الشريط الجانبي
        window.stoppedRequestsData = data || [];

      } catch (error) {
        console.error("❌ خطأ في تحميل طلبات الوقف:", error);
        window.stoppedRequestsData = [];
      }
    }

    // ✅ حفظ الموقع الجغرافي
    async function updateLastLoginWithLocation(agent_id) {
      if (!navigator.geolocation) return;

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const { latitude, longitude } = pos.coords;
        await supabase
          .from("agent_locations")
          .insert([{ agent_id, latitude, longitude }]);
      });
    }

    // ⚡️ عرض واجهة التحصيل الجماعي
    function showBulkCollectInterface() {
      const checkboxes = document.querySelectorAll('.customer-checkbox:checked');

      if (checkboxes.length === 0) {
        alert('⚠️ الرجاء تحديد عملاء أولاً');
        return;
      }

      const modalOverlay = document.getElementById('modalOverlay');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      // Check if modal elements exist
      if (!modalOverlay || !modalTitle || !modalBody) {
        console.error('Modal elements not found in showBulkCollectInterface, creating modal...');
        createModalIfNotExists();

        // Retry after creating modal
        setTimeout(() => showBulkCollectInterface(), 200);
        return;
      }

      modalTitle.textContent = `التحصيل الجماعي (${checkboxes.length} عملاء)`;

      let html = `
            <div style="padding: 20px;">
              <div style="background: var(--light-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: var(--primary-color);">تأكيد التحصيل الجماعي</h4>
                <p style="margin: 0;">سيتم تحصيل مبالغ <strong>${checkboxes.length}</strong> عملاء دفعة واحدة</p>
              </div>
              <div style="text-align: center;">
                <button class="btn btn-success btn-lg" onclick="executeBulkCollect()">
                  <i class="fas fa-check-circle"></i>
                  تأكيد التحصيل الجماعي
                </button>
                <button class="btn btn-secondary" onclick="closeModal()" style="margin-right: 10px;">
                  <i class="fas fa-times"></i>
                  إلغاء
                </button>
              </div>
            </div>
          `;

      modalBody.innerHTML = html;
      modalOverlay.classList.add('active');
    };

    // ⚡️ تنفيذ التحصيل الجماعي
    async function executeBulkCollect() {
      const checkboxes = document.querySelectorAll('.customer-checkbox:checked');
      const agent_id = localStorage.getItem("agent_id");

      if (!agent_id) {
        alert('⚠️ لا يمكن تحديد المندوب');
        return;
      }

      const loading = document.getElementById("loadingOverlay");
      loading.classList.add("active");

      try {
        const collections = [];

        const periodLabel = new Date().toISOString().slice(0, 7);

        // تحديث العملاء وإضافة سجلات التحصيل
        for (const checkbox of checkboxes) {
          const customer = customersData.find(c => c.id === checkbox.value);
          if (customer) {
            const amount = customer.display_amount ||
              (parseFloat(customer.package_price || 0) + parseFloat(customer.debt_amount || 0) + parseFloat(customer.due_amount || 0)) ||
              customer.amount || 0;

            const collectNotes = document.getElementById(`collectNotes_${customer.id}`)?.value || '';

            // تحديث حالة العميل وتصفير المبلغ
            const { error: updateError } = await supabase
              .from("customers")
              .update({
                collection_status: "تم التحصيل",
                debt_amount: 0,  // ✅ تصفير المبلغ المستحق
                due_amount: 0
              })
              .eq("id", customer.id);

            if (updateError) {
              console.error("❌ خطأ في تحديث العميل:", updateError);
              continue;
            }

            // إضافة سجل التحصيل
            const { error: insertError } = await supabase
              .from("collections")
              .insert({
                customer_id: customer.id,
                collected_by: agent_id,
                amount: amount,
                package_price: parseFloat(customer.package_price || 0),
                period_label: periodLabel,
                notes: collectNotes || null
              });

            if (insertError) {
              console.error("❌ خطأ في إدخال التحصيل:", insertError);
            }
          }
        }

        alert(`✅ تم تحصيل ${checkboxes.length} عميل بنجاح`);
        closeModal();

        // إعادة تحميل البيانات
        await loadCustomers(agent_id, true);

      } catch (error) {
        console.error("❌ خطأ في التحصيل الجماعي:", error);
        alert("⚠️ حدث خطأ أثناء التحصيل الجماعي: " + (error.message || "خطأ غير معروف"));
      } finally {
        loading.classList.remove("active");
      }
    };


    // ⚡️ اختبار قاعدة البيانات
    async function testDatabase() {
      console.log("🧪 اختبار الاتصال بقاعدة البيانات...");

      const agent_id = localStorage.getItem("agent_id");
      console.log("🔑 Agent ID:", agent_id);

      if (!agent_id) {
        console.error("❌ لا يوجد agent_id");
        return;
      }

      try {
        // اختبار جلب العملاء
        console.log("📥 اختبار جلب العملاء...");
        const { data: customers, error: customersError } = await supabase
          .from("customers")
          .select("*")
          .eq("agent_id", agent_id);

        if (customersError) {
          console.error("❌ خطأ في جلب العملاء:", customersError);
        } else {
          console.log("✅ العملاء:", customers);
          console.log("📊 عدد العملاء:", customers?.length || 0);

          const collected = customers?.filter(c => c.collection_status === "تم التحصيل") || [];
          console.log("💰 العملاء المحصلين:", collected.length);
        }

        // اختبار جلب طلبات الوقف
        console.log("📥 اختبار جلب طلبات الوقف...");
        const { data: stopRequests, error: stopError } = await supabase
          .from("stop_requests")
          .select("*")
          .eq("agent_id", agent_id);

        if (stopError) {
          console.error("❌ خطأ في جلب طلبات الوقف:", stopError);
        } else {
          console.log("✅ طلبات الوقف:", stopRequests);
          console.log("📊 عدد طلبات الوقف:", stopRequests?.length || 0);
        }

      } catch (error) {
        console.error("❌ خطأ عام في الاختبار:", error);
      }
    };

    // ⚡️ إخفاء الزر العائم
    function hideFloatingBulkCollect() {
      const floatingBtn = document.getElementById('floatingBulkCollect');
      floatingBtn.style.display = 'none';

      // إلغاء تحديد كل العملاء
      deselectAllCustomers();
    };

    // ⚡️ الانتقال السريع للتقارير الموحدة
    async function showUnifiedReports(tabName = 'collected') {
      console.log("🔄 الانتقال للتقارير الموحدة");

      // التحقق من agent_id
      const agent_id = localStorage.getItem("agent_id");
      console.log("🔑 Agent ID from localStorage:", agent_id);

      if (!agent_id) {
        console.error("❌ لا يوجد agent_id في localStorage");
        alert("❌ لم يتم العثور على معرف المندوب. يرجى تسجيل الدخول مرة أخرى.");
        return;
      }

      // إغلاق جميع الأكورديون ماعدا الأكورديون الموحد
      document.querySelectorAll('.accordion-body').forEach(accordion => {
        if (accordion.id !== 'unifiedSection') {
          accordion.classList.remove('active');
          const header = accordion.previousElementSibling;
          if (header) {
            header.classList.remove('active');
          }
        }
      });

      // فتح الأكورديون الموحد
      const unifiedAccordion = document.getElementById('unifiedSection');
      if (unifiedAccordion) {
        unifiedAccordion.classList.add('active');
        const unifiedHeader = unifiedAccordion.previousElementSibling;
        if (unifiedHeader) {
          unifiedHeader.classList.add('active');
        }
      }

      // تحميل جميع البيانات
      console.log("📥 جاري تحميل البيانات الموحدة...");
      await loadCustomers(agent_id, true);
      await loadStoppedCustomers(agent_id);
      await loadCustomerNotes(agent_id);

      // عرض البيانات في التبويب النشط
      const activeTab = document.querySelector('.tab-btn.active');
      if (activeTab) {
        const tabName = activeTab.getAttribute('data-tab');
        if (tabName === 'collected') {
          displayCollectedCustomers(customersData);
        }
      }

      // التمرير السلس للأعلى
      window.scrollTo({ top: 0, behavior: 'smooth' });

      // إزالة الكلاس active من جميع عناصر القائمة وإضافته للعنصر الحالي
      document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
        if (item.onclick && item.onclick.toString().includes('showUnifiedReports')) {
          item.classList.add('active');
        }
      });
    };

    // ⚡️ عرض التبويب المحدد
    window.showUnifiedTab = async function (tabName) {
      console.log(`🔄 عرض التبويب: ${tabName}`);
      console.log("📊 customersData متوفرة:", customersData ? customersData.length : "لا");

      // إزالة الكلاس active من جميع التبويبات
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      // إضافة الكلاس active للتبويب المحدد
      const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
      const activeContent = document.getElementById(`${tabName}Tab`);

      if (activeBtn) activeBtn.classList.add('active');
      if (activeContent) activeContent.classList.add('active');

      // تحميل البيانات الخاصة بالتبويب
      const agent_id = localStorage.getItem("agent_id");
      if (agent_id) {
        if (tabName === 'collected') {
          console.log("📥 تحديث العملاء المحصلين...");
          if (customersData && customersData.length > 0) {
            displayCollectedCustomers(customersData);
          } else {
            console.warn("⚠️ customersData غير متوفرة أو فارغة");
            // إعادة تحميل البيانات
            loadCustomers(agent_id).then(() => {
              if (customersData && customersData.length > 0) {
                displayCollectedCustomers(customersData);
              }
            });
          }
        } else if (tabName === 'stopped') {
          console.log("📥 تحديث طلبات الوقف...");
          displayStoppedRequests();
        } else if (tabName === 'notes') {
          console.log("📥 تحميل ملاحظات العملاء...");
          displayCustomerNotes();
        }
      }
    };

    // ⚡️ عرض طلبات الوقف في التبويب الرئيسي
    function displayStoppedRequests() {
      const stoppedContent = document.getElementById('stoppedRequestsContent');
      const stoppedRequests = window.stoppedRequestsData || [];

      if (stoppedRequests.length === 0) {
        stoppedContent.innerHTML = '<p style="text-align: center; padding: 20px;">لا توجد طلبات وقف حالياً</p>';
        return;
      }

      let html = `
            <div style="overflow-x: auto;">
              <table class="modern-table">
                <thead>
                  <tr>
                    <th>اسم العميل</th>
                    <th>الموبايل</th>
                    <th>السبب</th>
                    <th>التاريخ</th>
                    <th>الحالة</th>
                  </tr>
                </thead>
                <tbody>
          `;

      stoppedRequests.forEach(request => {
        html += `
              <tr>
                <td>${request.customer_name || 'غير محدد'}</td>
                <td>${request.customer_phone || 'غير محدد'}</td>
                <td>${request.reason || 'غير محدد'}</td>
                <td>${new Date(request.created_at).toLocaleDateString('ar-EG')}</td>
                <td><span class="status-badge pending">${request.status || 'معلق'}</span></td>
              </tr>
            `;
      });

      html += `
                </tbody>
              </table>
            </div>
          `;

      stoppedContent.innerHTML = html;
    }

    // ⚡️ التراجع عن التحصيل
    async function rollbackCollection(customerId, customerName) {
      if (!confirm(`⚠️ هل أنت متأكد من التراجع عن تحصيل العميل ${customerName}؟`)) return;

      const agent_id = localStorage.getItem("agent_id");
      if (!agent_id) {
        alert('⚠️ لا يمكن تحديد المندوب');
        return;
      }

      const loading = document.getElementById("loadingOverlay");
      loading.classList.add("active");

      try {
        // حذف سجل التحصيل
        const { error: deleteError } = await supabase
          .from("collections")
          .delete()
          .eq("customer_id", customerId)
          .eq("collected_by", agent_id);

        if (deleteError) {
          console.error("❌ خطأ في حذف التحصيل:", deleteError);
          throw deleteError;
        }

        // ✅ إصلاح: لا نستعيد debt_amount القديم لأنه تم تصفيره عند التحصيل
        // العميل يعود لحالة "لم يتم التحصيل" بدون ديون (الباقة موجودة دائماً)
        const { error: updateError } = await supabase
          .from("customers")
          .update({
            collection_status: "لم يتم التحصيل"
          })
          .eq("id", customerId);

        if (updateError) {
          console.error("❌ خطأ في تحديث حالة العميل:", updateError);
          throw updateError;
        }

        alert(`✅ تم التراجع عن تحصيل العميل ${customerName} بنجاح`);
        closeModal();

        // إعادة تحميل البيانات
        await loadCustomers(agent_id, true);

      } catch (error) {
        console.error("❌ خطأ في التراجع عن التحصيل:", error);
        alert("⚠️ حدث خطأ أثناء التراجع عن التحصيل: " + (error.message || "خطأ غير معروف"));
      } finally {
        loading.classList.remove("active");
      }
    };

    // ⚡️ عرض تفاصيل العميل
    function viewCustomerDetails(customerId) {
      const customer = customersData.find(c => c.id === customerId);
      if (!customer) return;

      const modalOverlay = document.getElementById('modalOverlay');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      // Check if modal elements exist
      if (!modalOverlay || !modalTitle || !modalBody) {
        console.error('Modal elements not found in viewCustomerDetails, creating modal...');
        createModalIfNotExists();

        // Retry after creating modal
        setTimeout(() => viewCustomerDetails(customerId), 200);
        return;
      }

      modalTitle.textContent = 'تفاصيل العميل';

      // Show correct amount - if collected, use actual collected amount, otherwise use display_amount (which includes both debt and due)
      const amount = customer.collection_status === "تم التحصيل"
        ? Math.max(
          parseFloat(collectionAmounts[customer.id] || 0) || 0,
          parseFloat(customer.display_amount || 0) || 0,
          parseFloat(customer.package_price || 0) || 0,
          parseFloat(customer.amount || 0) || 0
        )
        : (customer.display_amount || 0);

      let html = `
            <div style="padding: 20px;">
              <div style="background: var(--light-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: var(--primary-color);">${customer.name || customer.customer_name || 'غير معروف'}</h4>
                <p style="margin: 5px 0;"><strong>الموبايل:</strong> ${customer.phone || customer.customer_phone || 'غير محدد'}</p>
                <p style="margin: 5px 0;"><strong>العنوان:</strong> ${customer.address || 'غير محدد'}</p>
                <p style="margin: 5px 0;"><strong>المبلغ المستحق:</strong> <span style="color: var(--accent-color); font-weight: bold;">${amount} ج.م</span></p>
                <p style="margin: 5px 0;"><strong>القسم:</strong> ${customer.section || 'غير محدد'}</p>
                <p style="margin: 5px 0;"><strong>فئة الباقة:</strong> ${customer.package_category || 'غير محدد'}</p>
                <p style="margin: 5px 0;"><strong>حالة التحصيل:</strong> ${customer.collection_status || 'لم يتم التحصيل'}</p>
              </div>
              <div style="text-align: center;">
                <button class="btn btn-primary" onclick="closeModal()">إغلاق</button>
              </div>
            </div>
          `;

      modalBody.innerHTML = html;
      modalOverlay.classList.add('active');
    };

    // ⚡️ عرض ملاحظات العملاء في المودال
    function displayCustomerNotes() {
      const modalBody = document.getElementById('modalBody');
      const customerNotes = window.customerNotesData || [];

      if (customerNotes.length === 0) {
        modalBody.innerHTML = '<p style="text-align: center; padding: 20px;">لا توجد ملاحظات حالياً</p>';
        return;
      }

      let html = `
            <div style="overflow-x: auto;">
              <table class="modern-table">
                <thead>
                  <tr>
                    <th>اسم العميل</th>
                    <th>الموبايل</th>
                    <th>الملاحظة</th>
                    <th>التاريخ</th>
                    <th>إجراءات</th>
                  </tr>
                </thead>
                <tbody>
          `;

      customerNotes.forEach(note => {
        html += `
              <tr>
                <td>${note.customer_name || 'غير محدد'}</td>
                <td>${note.customer_phone || 'غير محدد'}</td>
                <td>${note.note_text || note.note || 'غير محدد'}</td>
                <td>${new Date(note.created_at).toLocaleDateString('ar-EG')}</td>
                <td>
                  <button class="btn btn-danger btn-sm" onclick="deleteNote('${note.id}', '${note.customer_name}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            `;
      });

      html += `
                </tbody>
              </table>
            </div>
          `;

      modalBody.innerHTML = html;
    }

    // ⚡️ تحديث عرض الملاحظات في المودال بعد الحذف
    function refreshNotesModal() {
      const modalBody = document.getElementById('modalBody');
      const customerNotes = window.customerNotesData || [];

      if (customerNotes.length === 0) {
        modalBody.innerHTML = '<p style="text-align: center; padding: 20px;">لا توجد ملاحظات حالياً</p>';
        return;
      }

      let html = `
            <div style="overflow-x: auto;">
              <table class="modern-table">
                <thead>
                  <tr>
                    <th>اسم العميل</th>
                    <th>الموبايل</th>
                    <th>الملاحظة</th>
                    <th>التاريخ</th>
                    <th>إجراءات</th>
                  </tr>
                </thead>
                <tbody>
          `;

      customerNotes.forEach(note => {
        html += `
              <tr>
                <td>${note.customer_name || 'غير محدد'}</td>
                <td>${note.customer_phone || 'غير محدد'}</td>
                <td>${note.note_text || note.note || 'غير محدد'}</td>
                <td>${new Date(note.created_at).toLocaleDateString('ar-EG')}</td>
                <td>
                  <button class="btn btn-danger btn-sm" onclick="deleteNote('${note.id}', '${note.customer_name}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            `;
      });

      html += `
                </tbody>
              </table>
            </div>
          `;

      modalBody.innerHTML = html;
    }

    // ⚡️ حذف ملاحظة
    // ⚡️ حذف ملاحظة
    async function deleteNote(noteId, customerName) {
      if (!confirm(`⚠️ هل أنت متأكد من حذف ملاحظة العميل ${customerName}؟`)) return;

      try {
        const { error } = await supabase
          .from("agent_notes")
          .delete()
          .eq("id", noteId);

        if (error) {
          console.error("❌ خطأ في حذف الملاحظة:", error);
          alert("⚠️ حدث خطأ أثناء حذف الملاحظة");
          return;
        }

        alert("✅ تم حذف الملاحظة بنجاح");

        // إعادة تحميل الملاحظات
        await loadCustomerNotes();

        // تحديث عرض الملاحظات في المودال
        refreshNotesModal();
      } catch (error) {
        console.error("❌ خطأ في حذف الملاحظة:", error);
        alert("⚠️ حدث خطأ غير متوقع");
      }
    };

    // ⚡️ التحصيل الجماعي (محسن للأداء)
    window.bulkCollectCustomers = async () => {
      const agent_id = localStorage.getItem("agent_id");
      if (!agent_id) {
        alert("❌ليس لديك صلاحية");
        return;
      }

      const checkboxes = document.querySelectorAll('.customer-checkbox:checked');
      if (checkboxes.length === 0) {
        alert("⚠️ لم تحدد أي عميل");
        return;
      }

      if (!confirm(`❗ هل تريد تحصيل مبالغ ${checkboxes.length} عملاء؟`))
        return;

      const loading = document.getElementById("loadingOverlay");
      loading.classList.add("active");

      try {
        console.log(`🔄 بدء التحصيل الجماعي لـ ${checkboxes.length} عميل`);

        const customerIds = Array.from(checkboxes).map(cb => cb.value);

        // تحديث حالة العملاء دفعة واحدة (أسرع) - تصفير المبلغ وتحديث الحالة
        const { error: updateError } = await supabase
          .from("customers")
          .update({
            collection_status: "تم التحصيل",
            debt_amount: 0,  // ✅ تصفير المبلغ المستحق
            due_amount: 0    // ✅ تصفير أي مبلغ متبقي
          })
          .in("id", customerIds);

        if (updateError) {
          console.error("❌ خطأ في تحديث العملاء:", updateError);
          throw updateError;
        }

        // إضافة سجلات التحصيل دفعة واحدة (أسرع) - استخدام collected_by الصحيح
        const customerData = customersData.filter(c => customerIds.includes(c.id));
        const collections = customerData.map(c => {
          // compute full amount (display_amount should already include package+debt+due)
          const amt = c.display_amount ||
            (parseFloat(c.package_price || 0) + parseFloat(c.debt_amount || 0) + parseFloat(c.due_amount || 0)) || 0;
          return {
            customer_id: c.id,
            collected_by: agent_id,  // ✅ الحقل الصحيح
            amount: amt
          };
        });

        const { error: insertError } = await supabase
          .from("collections")
          .insert(collections);

        if (insertError) {
          console.error("❌ خطأ في إدخال التحصيلات:", insertError);
          throw insertError;
        }

        console.log("✅ تم التحصيل الجماعي بنجاح");

        // تحديث واجهة المستخدم فوراً
        checkboxes.forEach(checkbox => {
          const card = checkbox.closest('.customer-card');
          if (card) {
            card.style.background = 'linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(255, 255, 255, 1))';
            card.style.transform = 'scale(0.98)';
            setTimeout(() => {
              card.style.transform = '';
            }, 200);
          }
        });

        // إخفاء الزر العائم
        document.getElementById('floatingBulkCollect').style.display = 'none';

        alert("✅ تم تحصيل جميع العملاء المحددين");

        // إعادة تحميل البيانات بعد فترة قصيرة مع الحفاظ على الوضع الحالي
        setTimeout(async () => {
          await loadCustomers(agent_id, true);
          await loadAmounts(agent_id);
          deselectAllCustomers();
        }, 1000);

      } catch (error) {
        console.error("❌ خطأ في التحصيل الجماعي:", error);
        alert("⚠️ حدث خطأ أثناء التحصيل: " + (error.message || "خطأ غير معروف"));
      } finally {
        loading.classList.remove("active");
      }
    };

    // ⚡️ دالة التحصيل السريع
    async function quickCollect(customerId, amount, customerName) {
      // determine actual amount in case the passed value was just package_price
      const customer = customersData && customersData.find(c => String(c.id) === String(customerId));
      const calcAmount = customer
        ? (customer.display_amount ||
          (parseFloat(customer.package_price || 0) +
            parseFloat(customer.debt_amount || 0) +
            parseFloat(customer.due_amount || 0)))
        : parseFloat(amount) || 0;

      console.log(`⚡ تحصيل سريع للعميل: ${customerName} - المبلغ: ${calcAmount}`);

      const agent_id = localStorage.getItem("agent_id");
      if (!agent_id) {
        alert("❌ليس لديك صلاحية");
        return;
      }

      // تأكيد سريع
      if (!confirm(`⚡ تحصيل سريع: ${calcAmount} ج.م من ${customerName}؟`)) {
        return;
      }

      try {
        // تحديث حالة العميل فقط (تصفير المبلغ وتحديث الحالة)
        const { error } = await supabase
          .from("customers")
          .update({
            collection_status: "تم التحصيل",
            debt_amount: 0,  // ✅ تصفير المبلغ المستحق
            due_amount: 0
          })
          .eq("id", customerId);

        if (error) {
          console.error("❌ خطأ في التحصيل السريع:", error);
          alert("⚠️ حدث خطأ أثناء التحصيل");
          return;
        }

        // إضافة سجل التحصيل - استخدام الحقول الصحيحة
        await supabase.from("collections").insert([
          {
            customer_id: customerId,
            collected_by: agent_id,  // ✅ الحقل الصحيح
            amount: calcAmount
          },
        ]);

        console.log("✅ تم التحصيل السريع بنجاح");

        // رسالة نجاح سريعة
        const card = document.querySelector(`#quickActions_${customerId}`).closest('.customer-card');
        card.style.background = 'linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(255, 255, 255, 1))';
        card.style.transform = 'scale(0.98)';

        setTimeout(() => {
          card.style.transform = '';
        }, 200);

        // إعادة تحميل البيانات بعد فترة قصيرة مع الحفاظ على الوضع الحالي
        setTimeout(async () => {
          await loadCustomers(agent_id, true);
        }, 1000);

      } catch (error) {
        console.error("❌ خطأ في التحصيل السريع:", error);
        alert("⚠️ حدث خطأ غير متوقع");
      }
    };

    // ⚡️ تصدير الدوال الهامة للنطاق العام
    window.showRandomMotivationalMessage = showRandomMotivationalMessage;
    window.updateSelectedCount = updateSelectedCount;
    window.selectAllCustomers = selectAllCustomers;
    window.deselectAllCustomers = deselectAllCustomers;
    window.toggleSelectAll = toggleSelectAll;
    window.deleteNote = deleteNote;
    window.saveNote = saveNote;
    window.rollbackCollection = rollbackCollection;
    window.collect = collect;
    window.requestStopService = requestStopService;
    window.cancelStopRequest = cancelStopRequest;
    window.getWhatsAppLink = getWhatsAppLink;

    // UI Functions Exports
    window.toggleSidebar = toggleSidebar;
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.applyFilters = applyFilters;
    window.clearFilters = clearFilters;
    window.executeBulkCollect = executeBulkCollect;
    window.testDatabase = testDatabase;
    window.hideFloatingBulkCollect = hideFloatingBulkCollect;
    window.showUnifiedReports = showUnifiedReports;
    window.viewCustomerDetails = viewCustomerDetails;
    window.showUnifiedTab = showUnifiedTab;
    window.showBulkCollectInterface = showBulkCollectInterface;
    window.quickCollect = quickCollect;
    window.collectGroupedCustomers = collectGroupedCustomers;
    window.viewGroupedCustomerDetails = viewGroupedCustomerDetails;
    window.saveGroupedCustomerNote = saveGroupedCustomerNote;
    window.stopGroupedCustomerService = stopGroupedCustomerService;
    window.expandGroupedCustomers = expandGroupedCustomers;

    // ⚡️ دوال التعامل مع العملاء المجموعين
    async function collectGroupedCustomers(customerIds, customerName, totalAmount) {
      const ids = customerIds.split(',').map(id => id.trim()).filter(Boolean);
      const agent_id = localStorage.getItem("agent_id");
      const notes = document.getElementById(`collectNotes_${ids[0]}`)?.value || '';

      if (!confirm(`هل أنت متأكد من تحصيل مبلغ ${totalAmount} ج.م من العميل "${customerName}" (${ids.length} عملاء)؟`)) {
        return;
      }

      const loading = document.getElementById("loadingOverlay");

      try {
        loading.classList.add("active");

        // جلب بيانات العملاء لحساب المبلغ الصحيح لكل واحد
        const groupCustomers = customersData
          ? customersData.filter(c => ids.includes(String(c.id)))
          : [];

        const periodLabel = new Date().toISOString().slice(0, 7);
        const amountPaidTotal = parseFloat(totalAmount) || 0;
        let remainingToDistribute = amountPaidTotal;

        // ✅ حساب المبالغ لكل عميل (توزيع المبلغ المدفوع على المجموعة)
        const collectionsDataMap = ids.map((id, index) => {
          const customer = groupCustomers.find(c => String(c.id) === id);
          const customerTotalDue = customer ? (parseFloat(customer.package_price || 0) + parseFloat(customer.debt_amount || 0) + parseFloat(customer.due_amount || 0)) : 0;

          let amountForThisOne = 0;
          if (remainingToDistribute >= customerTotalDue) {
            amountForThisOne = customerTotalDue;
            remainingToDistribute -= customerTotalDue;
          } else {
            amountForThisOne = remainingToDistribute;
            remainingToDistribute = 0;
          }

          // إذا كان هذا آخر عميل وهناك فائض في المبلغ المدفوع
          if (index === ids.length - 1 && remainingToDistribute > 0) {
            amountForThisOne += remainingToDistribute;
          }

          const remaining = Math.max(0, customerTotalDue - amountForThisOne);

          return {
            id,
            paid: amountForThisOne,
            remaining: remaining,
            customer: customer
          };
        });

        // ✅ تحديث كل العملاء في المجموعة
        const updatePromises = collectionsDataMap.map(item => {
          const status = item.remaining > 0 ? "تحصيل جزئي" : "تم التحصيل";
          return supabase
            .from("customers")
            .update({
              collection_status: status,
              debt_amount: item.remaining,
              due_amount: 0
            })
            .eq("id", item.id);
        });

        const results = await Promise.all(updatePromises);
        const errors = results.filter(r => r.error);
        if (errors.length > 0) {
          const errorMessages = errors.map(e => e.error?.message || 'Unknown error').join(', ');
          throw new Error(`فشل تحديث بعض العملاء: ${errorMessages}`);
        }

        // ✅ تسجيل سجل تحصيل لكل عميل في جدول collections بالمبلغ المدفوع فعلياً
        const collectionsToInsert = collectionsDataMap.map(item => {
          return {
            customer_id: item.id,
            collected_by: agent_id,
            amount: item.paid || 0,
            package_price: parseFloat(item.customer?.package_price || 0),
            period_label: periodLabel,
            notes: notes || null
          };
        });

        await supabase.from("collections").insert(collectionsToInsert);

        loading.classList.remove("active");
        alert(`✅ تم تحصيل مبلغ ${totalAmount} ج.م من ${ids.length} عملاء بنجاح!`);

        // إعادة تحميل البيانات مع الحفاظ على الوضع الحالي
        await loadCustomers(agent_id, true);

      } catch (error) {
        console.error("❌ خطأ في تحصيل العملاء المجموعين:", error);
        alert("⚠️ حدث خطأ أثناء تحصيل العملاء: " + error.message);
        loading.classList.remove("active");
      }
    };

    function viewGroupedCustomerDetails(customerIds, customerName) {
      const ids = customerIds.split(',');
      const customers = customersData.filter(c => ids.includes(c.id.toString()));

      let detailsHTML = `
            <div style="max-height: 500px; overflow-y: auto;">
              <h3 style="color: var(--primary-color); margin-bottom: 20px;">تفاصيل العملاء المجموعين: ${customerName}</h3>
          `;

      customers.forEach((customer, index) => {
        const amount = parseFloat(customer.display_amount || 0) || 0;
        detailsHTML += `
              <div style="background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 10px; border-right: 3px solid var(--primary-color);">
                <h4 style="color: var(--primary-color); margin-bottom: 10px;">العميل ${index + 1}</h4>
                <p><strong>الاسم:</strong> ${customer.name || customer.customer_name}</p>
                <p><strong>الهاتف:</strong> ${customer.phone || customer.customer_phone}</p>
                <p><strong>العنوان:</strong> ${customer.address || customer.customer_address}</p>
                <p><strong>المبلغ:</strong> ${amount} ج.م</p>
                <p><strong>الملاحظات:</strong> ${customer.notes || customer.customer_notes || 'لا توجد'}</p>
                <p><strong>القسم:</strong> ${customer.section || 'غير محدد'}</p>
              </div>
            `;
      });

      detailsHTML += `
            <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); padding: 15px; border-radius: 10px; margin-top: 20px;">
              <h4 style="color: #155724; margin-bottom: 10px;">ملخص الإجمالي</h4>
              <p><strong>عدد العملاء:</strong> ${customers.length}</p>
              <p><strong>إجمالي المبلغ:</strong> ${customers.reduce((sum, c) => sum + (parseFloat(c.display_amount || 0) || 0), 0).toFixed(2)} ج.م</p>
            </div>
          </div>
          `;

      // عرض المودال بالتفاصيل
      showModal('تفاصيل العملاء المجموعين', detailsHTML);
    };

    async function saveGroupedCustomerNote(customerIds, customerName) {
      const ids = customerIds.split(',');
      const notes = document.getElementById(`collectNotes_${ids[0]}`)?.value || '';

      if (!notes.trim()) {
        alert("⚠️ يرجى إدخال ملاحظات أولاً");
        return;
      }

      try {
        const loading = document.getElementById("loadingOverlay");
        loading.classList.add("active");

        // تحديث ملاحظات كل العملاء في المجموعة
        const updatePromises = ids.map(id => {
          const trimmedId = id.trim();
          if (!trimmedId) {
            console.warn('Empty customer ID found, skipping');
            return Promise.resolve({ error: null, data: null });
          }

          return supabase
            .from("customers")
            .update({
              notes: notes
            })
            .eq("id", trimmedId);
        });

        await Promise.all(updatePromises);

        loading.classList.remove("active");
        alert(`✅ تم حفظ الملاحظات لـ ${ids.length} عملاء بنجاح!`);

        // إعادة تحميل البيانات مع الحفاظ على العرض الحالي
        loadCustomers(localStorage.getItem("agent_id"), true);

      } catch (error) {
        console.error("❌ خطأ في حفظ الملاحظات:", error);
        alert("⚠️ حدث خطأ أثناء حفظ الملاحظات: " + error.message);
        const loading = document.getElementById("loadingOverlay");
        loading.classList.remove("active");
      }
    };

    async function stopGroupedCustomerService(customerIds, customerName) {
      const ids = customerIds.split(',');

      if (!confirm(`هل أنت متأكد من إيقاف خدمة ${ids.length} عملاء باسم "${customerName}"؟`)) {
        return;
      }

      try {
        const loading = document.getElementById("loadingOverlay");
        loading.classList.add("active");

        // إيقاف خدمة كل العملاء في المجموعة
        const updatePromises = ids.map(id => {
          const trimmedId = id.trim();
          if (!trimmedId) {
            console.warn('Empty customer ID found, skipping');
            return Promise.resolve({ error: null, data: null });
          }

          return supabase
            .from("customers")
            .update({
              collection_status: "تم الإيقاف",
              debt_amount: 0,
              due_amount: 0
            })
            .eq("id", trimmedId);
        });

        const results = await Promise.all(updatePromises);

        // Check for errors
        const errors = results.filter(result => result.error);
        if (errors.length > 0) {
          console.error('Update errors:', errors);
          const errorMessages = errors.map(e => e.error?.message || 'Unknown error').join(', ');
          throw new Error(`فشل إيقاف خدمة بعض العملاء: ${errorMessages}`);
        }

        loading.classList.remove("active");
        alert(`✅ تم إيقاف خدمة ${ids.length} عملاء بنجاح!`);

        // إعادة تحميل البيانات مع الحفاظ على العرض الحالي
        loadCustomers(localStorage.getItem("agent_id"), true);

      } catch (error) {
        console.error("❌ خطأ في إيقاف الخدمة:", error);
        alert("⚠️ حدث خطأ أثناء إيقاف الخدمة: " + error.message);
        const loading = document.getElementById("loadingOverlay");
        loading.classList.remove("active");
      }
    };

    function expandGroupedCustomers(customerIds) {
      const ids = customerIds.split(',');
      const customers = customersData.filter(c => ids.includes(c.id.toString()));

      let expandHTML = `
            <div style="max-height: 600px; overflow-y: auto;">
              <h3 style="color: var(--primary-color); margin-bottom: 20px;">توسيع عرض العملاء</h3>
          `;

      customers.forEach((customer, index) => {
        const amount = customer.display_amount ||
          (parseFloat(customer.package_price || 0) + parseFloat(customer.debt_amount || 0) + parseFloat(customer.due_amount || 0)) || 0;
        expandHTML += `
              <div class="customer-card" style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <h4 style="color: var(--primary-color); margin: 0;">العميل ${index + 1}: ${customer.name || customer.customer_name}</h4>
                  <span style="background: var(--accent-color); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${amount} ج.م</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                  <div><strong>الهاتف:</strong> ${customer.phone || customer.customer_phone}</div>
                  <div><strong>القسم:</strong> ${customer.section || 'غير محدد'}</div>
                  <div style="grid-column: 1 / -1;"><strong>العنوان:</strong> ${customer.address || customer.customer_address}</div>
                  <div style="grid-column: 1 / -1;"><strong>الملاحظات:</strong> ${customer.notes || customer.customer_notes || 'لا توجد'}</div>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 15px;">
                  <button onclick="collect('${customer.id}', '${customer.name || customer.customer_name}', '${amount}')" class="btn btn-success btn-sm">تحصيل</button>
                  <button onclick="window.open('https://wa.me/${(customer.phone || customer.customer_phone || '').replace(/\D/g, '')}', '_blank')" class="btn btn-info btn-sm">واتساب</button>
                  <button onclick="viewCustomerDetails('${customer.id}')" class="btn btn-primary btn-sm">تفاصيل</button>
                </div>
              </div>
            `;
      });

      expandHTML += `</div>`;

      // عرض المودال بالعملاء الموسعين
      showModal('توسيع العملاء', expandHTML);
    };

    // دالة مساعدة لعرض المودال
    function showModal(title, content) {
      const modalHTML = `
            <div id="groupedCustomersModal" class="modal-overlay active" style="z-index: 999999;">
              <div class="modal-content" style="max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; background: white; border-radius: 15px; padding: 30px; position: relative;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef;">
                  <h2 style="margin: 0; color: var(--primary-color);">${title}</h2>
                  <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d; padding: 5px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;" onmouseover="this.style.background='#f8f9fa'; this.style.color='#dc3545';" onmouseout="this.style.background='none'; this.style.color='#6c757d';">×</button>
                </div>
                ${content}
              </div>
            </div>
          `;

      // إزالة أي مودال موجود
      const existingModal = document.getElementById('groupedCustomersModal');
      if (existingModal) {
        existingModal.remove();
      }

      // إضافة المودال الجديد
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    // ⚡️ تحديث حالة فترة التحصيل
    // ⚡️ تحديث حالة فترة التحصيل
    async function updateCollectionPeriodStatus() {
      try {
        const agent_id = localStorage.getItem("agent_id");
        const statusElement = document.getElementById('currentPeriodInfo');
        const modalStatusElement = document.getElementById('modalCurrentPeriodInfo');
        const overdueCountElement = document.getElementById('overdueCustomersCount');
        const modalOverdueCountElement = document.getElementById('modalOverdueCustomersCount');

        if (!agent_id) return;

        // Get current customers for this agent
        const { data: customers } = await supabase
          .from('customers')
          .select('*')
          .eq('agent_id', agent_id);

        if (!customers) return;

        // Get collections for correct amounts
        const { data: collections } = await supabase
          .from('collections')
          .select('*')
          .eq('collected_by', agent_id);

        // Create a map of customer_id to collection amount
        const collectionAmounts = {};
        collections?.forEach(collection => {
          if (collection.customer_id) {
            const amount = collection.amount || collection.original_amount || collection.debt_amount || collection.due_amount || 0;
            collectionAmounts[collection.customer_id] = parseFloat(amount) || 0;
          }
        });

        // Process customers with collection amounts (aligned with Admin Dashboard logic)
        const processedCustomers = customers.map(customer => {
          const amount = customer.collection_status === 'تم التحصيل'
            ? Math.max(
              parseFloat(collectionAmounts[customer.id] || 0) || 0,
              parseFloat(customer.display_amount || 0) || 0,
              parseFloat(customer.package_price || 0) || 0
            )
            : (parseFloat(customer.package_price || 0) + parseFloat(customer.debt_amount || 0) + parseFloat(customer.due_amount || 0));

          return {
            ...customer,
            display_amount: parseFloat(amount) || 0
          };
        });

        const totalCustomers = processedCustomers.length;
        const collectedCustomers = processedCustomers.filter(c => c.collection_status === 'تم التحصيل').length;
        const uncollectedCustomers = totalCustomers - collectedCustomers;
        const overdueCustomers = processedCustomers.filter(c => (c.overdue_periods || 0) > 0);

        // Calculate period statistics using processed customers
        const totalAmount = processedCustomers.reduce((sum, c) => sum + (c.display_amount || 0), 0);
        const collectedAmount = processedCustomers.filter(c => c.collection_status === 'تم التحصيل').reduce((sum, c) => sum + (c.display_amount || 0), 0);
        const collectionRate = totalCustomers > 0 ? ((collectedCustomers / totalCustomers) * 100).toFixed(1) : 0;

        // Update status display for both main page and modal
        const statusHTML = `
              <strong>📊 إجمالي العملاء:</strong> ${totalCustomers} | 
              <strong>✅ تم التحصيل:</strong> ${collectedCustomers} | 
              <strong>⏳ لم يتم:</strong> ${uncollectedCustomers} | 
              <strong>📈 نسبة التحصيل:</strong> ${collectionRate}% | 
              <strong>💰 إجمالي المبلغ:</strong> ${totalAmount.toFixed(2)} ج.م
            `;

        if (statusElement) {
          statusElement.innerHTML = statusHTML;
        }
        if (modalStatusElement) {
          modalStatusElement.innerHTML = statusHTML;
        }

        if (overdueCountElement) {
          overdueCountElement.textContent = overdueCustomers.length;
        }
        if (modalOverdueCountElement) {
          modalOverdueCountElement.textContent = overdueCustomers.length;
        }

        // Add warning color if there are overdue customers
        if (overdueCustomers.length > 0) {
          if (overdueCountElement) overdueCountElement.style.color = '#dc3545';
          if (modalOverdueCountElement) modalOverdueCountElement.style.color = '#dc3545';
          if (statusElement) statusElement.style.color = '#ff6b35';
          if (modalStatusElement) modalStatusElement.style.color = '#ff6b35';
        }

      } catch (error) {
        console.error('Error updating collection period status:', error);
      }
    };
    window.updateCollectionPeriodStatus = updateCollectionPeriodStatus;

    // ⚡️ تحديث إحصائيات الفترة
    window.updatePeriodStats = async () => {
      try {
        const agent_id = localStorage.getItem("agent_id");
        const statsContent = document.getElementById('periodStatsContent');

        if (!agent_id || !statsContent) return;

        // Get current customers for this agent
        const { data: customers } = await supabase
          .from('customers')
          .select('*')
          .eq('agent_id', agent_id);

        if (!customers) return;

        // Get collections for correct amounts
        const { data: collections } = await supabase
          .from('collections')
          .select('*')
          .eq('collected_by', agent_id);

        // Create a map of customer_id to collection amount
        const collectionAmounts = {};
        collections?.forEach(collection => {
          if (collection.customer_id) {
            const amount = collection.amount || collection.original_amount || collection.debt_amount || collection.due_amount || 0;
            collectionAmounts[collection.customer_id] = parseFloat(amount) || 0;
          }
        });

        // Process customers with collection amounts (aligned with Admin Dashboard logic)
        const processedCustomers = customers.map(customer => {
          const amount = customer.collection_status === 'تم التحصيل'
            ? Math.max(
              parseFloat(collectionAmounts[customer.id] || 0) || 0,
              parseFloat(customer.display_amount || 0) || 0,
              parseFloat(customer.package_price || 0) || 0
            )
            : (parseFloat(customer.package_price || 0) + parseFloat(customer.debt_amount || 0) + parseFloat(customer.due_amount || 0));

          return {
            ...customer,
            display_amount: parseFloat(amount) || 0
          };
        });

        const totalCustomers = processedCustomers.length;
        const collectedCustomers = processedCustomers.filter(c => c.collection_status === 'تم التحصيل').length;
        const uncollectedCustomers = totalCustomers - collectedCustomers;
        const overdueCustomers = processedCustomers.filter(c => (c.overdue_periods || 0) > 0);

        // Calculate period statistics using processed customers
        const totalAmount = processedCustomers.reduce((sum, c) => sum + (c.display_amount || 0), 0);
        const collectedAmount = processedCustomers.filter(c => c.collection_status === 'تم التحصيل').reduce((sum, c) => sum + (c.display_amount || 0), 0);
        const collectionRate = totalCustomers > 0 ? ((collectedCustomers / totalCustomers) * 100).toFixed(1) : 0;

        // Calculate statistics by sections
        const sectionsStats = {};
        processedCustomers.forEach(customer => {
          const section = customer.section || 'غير محدد';
          if (!sectionsStats[section]) {
            sectionsStats[section] = {
              total: 0,
              collected: 0,
              amount: 0
            };
          }
          sectionsStats[section].total++;
          sectionsStats[section].amount += customer.display_amount || 0;
          if (customer.collection_status === 'تم التحصيل') {
            sectionsStats[section].collected++;
          }
        });

        let statsHTML = `
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: bold;">${totalCustomers}</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">إجمالي العملاء</div>
                </div>
                <div style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: bold;">${collectedCustomers}</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">العملاء المحصلين</div>
                </div>
                <div style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: bold;">${uncollectedCustomers}</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">العملاء المتبقيين</div>
                </div>
                <div style="background: linear-gradient(135deg, #43e97b, #38f9d7); color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: bold;">${collectionRate}%</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">نسبة التحصيل</div>
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: linear-gradient(135deg, #fa709a, #fee140); color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: bold;">${totalAmount.toFixed(2)} ج.م</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">إجمالي المبلغ</div>
                </div>
                <div style="background: linear-gradient(135deg, #30cfd0, #330867); color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: bold;">${collectedAmount.toFixed(2)} ج.م</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">المبلغ المحصل</div>
                </div>
                <div style="background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: bold;">${overdueCustomers.length}</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">العملاء المتأخرين</div>
                </div>
                <div style="background: linear-gradient(135deg, #a8edea, #fed6e3); color: #333; padding: 1rem; border-radius: 8px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: bold;">${(totalAmount - collectedAmount).toFixed(2)} ج.م</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">المبلغ المتبقي</div>
                </div>
              </div>
              
              <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                <h5 style="margin: 0 0 1rem 0; color: #333;">📊 إحصائيات حسب الأقسام</h5>
                <div style="overflow-x: auto;">
                  <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden;">
                    <thead>
                      <tr style="background: #667eea; color: white;">
                        <th style="padding: 0.5rem; text-align: right;">القسم</th>
                        <th style="padding: 0.5rem; text-align: right;">إجمالي</th>
                        <th style="padding: 0.5rem; text-align: right;">محصل</th>
                        <th style="padding: 0.5rem; text-align: right;">نسبة</th>
                        <th style="padding: 0.5rem; text-align: right;">المبلغ</th>
                      </tr>
                    </thead>
                    <tbody>
            `;

        Object.entries(sectionsStats).forEach(([section, stats]) => {
          const sectionRate = stats.total > 0 ? ((stats.collected / stats.total) * 100).toFixed(1) : 0;
          statsHTML += `
                <tr style="border-bottom: 1px solid #eee;">
                  <td style="padding: 0.5rem;">${section}</td>
                  <td style="padding: 0.5rem;">${stats.total}</td>
                  <td style="padding: 0.5rem;">${stats.collected}</td>
                  <td style="padding: 0.5rem;">${sectionRate}%</td>
                  <td style="padding: 0.5rem;">${stats.amount.toFixed(2)} ج.م</td>
                </tr>
              `;
        });

        statsHTML += `
                    </tbody>
                  </table>
                </div>
              </div>
            `;

        statsContent.innerHTML = statsHTML;

      } catch (error) {
        console.error('Error updating period stats:', error);
        const statsContent = document.getElementById('periodStatsContent');
        if (statsContent) {
          statsContent.innerHTML = '<div style="color: #dc3545; text-align: center;">❌ خطأ في تحميل الإحصائيات</div>';
        }
      }
    };

  </script>
</body>

</html>