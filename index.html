<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#2c3e50" />
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³" />
    <meta name="application-name" content="ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³" />
    <meta name="description" content="Ù†Ø¸Ø§Ù… Ù…ØªÙ‚Ø¯Ù… Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­ØµÙŠÙ„ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡" />
    <meta name="msapplication-TileColor" content="#2c3e50" />
    <meta name="msapplication-config" content="./browserconfig.xml" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="./Orange_logo.svg.png" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="./Orange_logo.svg.png" />
    
    <!-- Modern CSS Framework -->
    <link rel="stylesheet" href="./modern-styles.css">
    
    <style>
      /* Login Page Specific Styles */
      .login-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        position: relative;
        overflow: hidden;
      }
      
      .login-page::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.03)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.03)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.02)"/><circle cx="10" cy="50" r="0.5" fill="rgba(255,255,255,0.02)"/><circle cx="90" cy="30" r="0.5" fill="rgba(255,255,255,0.02)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        pointer-events: none;
      }
      
      .login-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.1);
        padding: 3rem;
        width: 100%;
        max-width: 420px;
        position: relative;
        z-index: 1;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      
      .login-header {
        text-align: center;
        margin-bottom: 2.5rem;
      }
      
      .login-logo {
        width: 80px;
        height: 80px;
        margin: 0 auto 1.5rem;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 24px rgba(44, 62, 80, 0.2);
      }
      
      .login-logo img {
        width: 50px;
        height: 50px;
        border-radius: 12px;
      }
      
      .login-title {
        font-size: var(--font-size-3xl);
        font-weight: 700;
        color: var(--dark-color);
        margin-bottom: 0.5rem;
      }
      
      .login-subtitle {
        color: var(--gray-600);
        font-size: var(--font-size-base);
        margin-bottom: 0;
      }
      
      .login-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      
      .input-group {
        position: relative;
      }
      
      .input-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-500);
        font-size: var(--font-size-lg);
        pointer-events: none;
        transition: var(--transition);
      }
      
      .form-control:focus + .input-icon {
        color: var(--primary-color);
      }
      
      .form-control {
        padding-right: 3rem;
        font-size: var(--font-size-base);
        border: 2px solid var(--gray-200);
        background: var(--white);
      }
      
      .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(44, 62, 80, 0.1);
      }
      
      .login-btn {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: var(--white);
        border: none;
        padding: 1rem 2rem;
        border-radius: var(--border-radius);
        font-size: var(--font-size-lg);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        min-height: 52px;
      }
      
      .login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(44, 62, 80, 0.3);
      }
      
      .login-btn:active {
        transform: translateY(0);
      }
      
      .login-btn.loading {
        color: transparent;
        pointer-events: none;
      }
      
      .login-btn.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: var(--white);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      .login-links {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--gray-200);
        flex-wrap: wrap;
        gap: 1rem;
      }
      
      .login-link {
        color: var(--primary-color);
        text-decoration: none;
        font-size: var(--font-size-sm);
        font-weight: 500;
        transition: var(--transition);
      }
      
      .login-link:hover {
        color: var(--secondary-color);
        text-decoration: underline;
      }
      
      .alert {
        border-radius: var(--border-radius);
        padding: 1rem 1.25rem;
        font-size: var(--font-size-sm);
        border: 1px solid transparent;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        animation: fadeIn 0.3s ease-out;
      }
      
      .alert-error {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #991b1b;
        border-color: #fca5a5;
      }
      
      .alert-success {
        background: linear-gradient(135deg, #dcfce7, #bbf7d0);
        color: #166534;
        border-color: #86efac;
      }
      
      .remember-forgot {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      
      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary-color);
      }
      
      .checkbox-group label {
        font-size: var(--font-size-sm);
        color: var(--gray-600);
        cursor: pointer;
      }
      
      /* Responsive Design */
      @media (max-width: 576px) {
        .login-container {
          margin: 1rem;
          padding: 2rem;
        }
        
        .login-title {
          font-size: var(--font-size-2xl);
        }
        
        .login-links {
          flex-direction: column;
          align-items: stretch;
          text-align: center;
        }
      }
      
      /* Animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      @keyframes spin {
        to {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }
    </style>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const supabase = createClient(
        "https://inguuoiolmbplubkwcvd.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImluZ3V1b2lvbG1icGx1Ymt3Y3ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1MDIxMjksImV4cCI6MjA4NjA3ODEyOX0.wRTnc2LRoy4d77K7RWOeglfsO51kCfN3NlRB7UvyD4Y"
      );

      window.login = async function () {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const alertBox = document.getElementById("alertBox");

        alertBox.style.display = "none";
        alertBox.className = "alert";

        if (!email || !password) {
          showAlert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.", "error");
          return;
        }

        // Show loading state
        const loginBtn = document.getElementById('loginBtn');
        loginBtn.classList.add('loading');
        loginBtn.disabled = true;

        try {
          // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¬Ø¯ÙˆÙ„ agents
          const { data: agentData, error: agentError } = await supabase
            .from("agents")
            .select("*")
            .eq("email", email.toLowerCase())
            .maybeSingle();

          if (agentError) {
            console.error("Database error:", agentError);
            showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.", "error");
            return;
          }

          if (!agentData) {
            showAlert("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„.", "error");
            return;
          }

          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ´ÙÙŠØ±)
          if (agentData.password !== password) {
            showAlert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.", "error");
            return;
          }

          // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙÙŠ localStorage
          localStorage.setItem("agent_id", agentData.id);
          localStorage.setItem("agent_name", agentData.name);
          localStorage.setItem("agent_email", agentData.email);
          localStorage.setItem("role", agentData.role);
          
          // Save remember me preference
          const rememberCheckbox = document.getElementById('remember');
          if (rememberCheckbox.checked) {
            localStorage.setItem('remember_email', email);
          } else {
            localStorage.removeItem('remember_email');
          }

          // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
          await supabase
            .from("agents")
            .update({ updated_at: new Date().toISOString() })
            .eq("id", agentData.id);

          // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙÙŠ Ø¬Ø¯ÙˆÙ„ login_logs
          await supabase.from("login_logs").insert([{ agent_id: agentData.id }]);

          showAlert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­. ÙŠØªÙ… Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...", "success");

          setTimeout(() => {
            if (agentData.role === "admin") {
              window.location.href = "admin-dashboard.html";
            } else {
              window.location.href = "collections.html";
            }
          }, 1500);

        } catch (error) {
          console.error("Login error:", error);
          showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "error");
        } finally {
          // Remove loading state
          const loginBtn = document.getElementById('loginBtn');
          loginBtn.classList.remove('loading');
          loginBtn.disabled = false;
        }
      };

      // Show alert helper function
      window.showAlert = function(message, type = 'error') {
        const alertBox = document.getElementById("alertBox");
        alertBox.style.display = "block";
        alertBox.className = type === 'error' ? 'alert alert-error' : 'alert alert-success';
        const icon = type === 'error' ? 'âš ï¸' : 'âœ…';
        alertBox.innerHTML = `<span>${icon}</span><span>${message}</span>`;
        
        if (type === 'success') {
          setTimeout(() => {
            alertBox.style.display = 'none';
          }, 3000);
        }
      };

      // Load remembered email on page load
      document.addEventListener('DOMContentLoaded', function() {
        const rememberedEmail = localStorage.getItem('remember_email');
        if (rememberedEmail) {
          document.getElementById('email').value = rememberedEmail;
          document.getElementById('remember').checked = true;
        }
      });
      
      // Service Worker Registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(error => {
              console.log('ServiceWorker registration failed: ', error);
            });
        });
      }

      // PWA Install Prompt
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Show install button or banner
        const installButton = document.createElement('button');
        installButton.textContent = 'Ø«Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚';
        installButton.style.cssText = `
          position: fixed;
          bottom: 20px;
          left: 20px;
          background: #3498db;
          color: white;
          border: none;
          padding: 12px 20px;
          border-radius: 6px;
          cursor: pointer;
          z-index: 1000;
          font-size: 14px;
        `;
        
        installButton.addEventListener('click', () => {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('User accepted the A2HS prompt');
            } else {
              console.log('User dismissed the A2HS prompt');
            }
            deferredPrompt = null;
            installButton.remove();
          });
        });
        
        document.body.appendChild(installButton);
      });
    </script>
  </head>

  <body class="login-page">
    <div class="login-container">
      <div class="login-header">
        <div class="login-logo">
          <img src="./Orange_logo.svg.png" alt="ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³">
        </div>
        <h1 class="login-title">ÙÙˆÙƒØ³ Ø¨ÙŠØ²Ù†ÙŠØ³</h1>
        <p class="login-subtitle">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</p>
      </div>
      
      <form class="login-form" onsubmit="return false;">
        <div id="alertBox" class="alert" style="display: none;"></div>
        
        <div class="input-group">
          <input 
            type="email" 
            id="email" 
            class="form-control" 
            placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" 
            autocomplete="username" 
            required
          >
          <span class="input-icon">ğŸ“§</span>
        </div>
        
        <div class="input-group">
          <input 
            type="password" 
            id="password" 
            class="form-control" 
            placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" 
            autocomplete="current-password" 
            required
          >
          <span class="input-icon">ğŸ”’</span>
        </div>
        
        <div class="remember-forgot">
          <div class="checkbox-group">
            <input type="checkbox" id="remember">
            <label for="remember">ØªØ°ÙƒØ±Ù†ÙŠ</label>
          </div>
        </div>
        
        <button type="submit" class="login-btn" onclick="login()" id="loginBtn">
          ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        </button>
      </form>
      
      <div class="login-links">
        <a href="./forget-pass.html" class="login-link">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a>
        <a href="./register.html" class="login-link">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a>
      </div>
    </div>
  </body>
</html>
